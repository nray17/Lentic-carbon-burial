
Code used in the manuscript:Wetlands dominate the global lentic carbon sink, by Ray et al

Datafiles and other files needed to run this code can be downloaded from the FigShare repository following this link: https://figshare.com/s/d928d5b76950c5e4cd0e

```{r}
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggtext)
library(patchwork)
library(sjstats)
library(Hmisc)
library(rsample)
library(rpart)
library(rpart.plot)
library(ranger)
library(raster)
library(ggplot2)
library(sf)
library(sp)
library(lme4)
library(emmeans)
library(tidymodels)
library(pdp)
library(readr)
library(reshape2)
```


Load the extracted data:
```{r}
#lakes/ponds/impounmdents
library(readr)
clean_lakes_2024_03_20 <- read_csv("clean_lakes_2024_03_20.csv")
View(clean_lakes_2024_03_20)

clean_lakes = clean_lakes_2024_03_20

#and the wetlands dataset
library(readr)
clean_wetlands_2024_03_20 <- read_csv("clean_wetlands_2024_03_20.csv")
View(clean_wetlands_2024_03_20)

clean_wetlands = clean_wetlands_2024_03_20
```


Make a map of all the sampling locations by biome
```{r}
require(sf)
biomes <- read_sf(dsn = ".", layer = "wwf_terr_ecos")

world <- map_data("world")

biome.colors = c("1" = "#809B82",
           "2" = "#84bb8e",
           "3" = "#81d4a5",
           "4" = "#c8e4a3",
           "5" = "#97b5bc",
           "6" = "#b1cbe5",
           "7" = "#b6a47f",
           "8" = "#d1c383",
           "9" = "#e5e184",
           "10" = "#F6F780",
           "11" = "#DCE7F5",
           "12" = "#E4B692",
           "13" = "#F6CCA2",
           "98" = "#8BB9E6")

biomes$BIOME = as.factor(biomes$BIOME)

reservoir = subset(clean_lakes, System_type == "Reservoir")
lake = subset(clean_lakes, System_type == "Lake" )
pond = subset(clean_lakes, System_type == "Pond")

#make the map
lake_cbury_all_map = ggplot() +
  geom_sf(data = biomes, aes(fill = BIOME), lwd = 0)+
  scale_fill_manual(values = biome.colors)+
  #scale_color_manual(values = biome.colors, alpha = 0)+
  labs(x = "Longitude", y = "Latitude", color = NULL)+
  theme_classic()+
  theme(panel.border = element_rect(colour = "black", fill = NA))+
  theme(legend.position = "none")+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_text(size = 7,colour = "black"),
        axis.title.x =  element_blank(),
         axis.title.y =  element_blank())+
  geom_point(data = lake, aes(x = Long, y = Lat), size = 1, shape = 19, color = "black")+
  geom_point(data = reservoir, aes(x = Long, y = Lat), size = 1, shape = 17, color = "black")+
  geom_point(data = pond, aes(x = Long, y = Lat), size = 1, shape = 23, color = "black", fill = "black")+
  geom_point(data = clean_wetlands, aes(x = Long, y = Lat), size = 1, shape = 15, color = "black")

lake_cbury_all_map
ggsave(filename = "lentic_c_bury_biome_map.png", plot = lake_cbury_all_map, width = 180, height = 100, units = "mm")
```


And now test for differences between biomes and make plots of biome and system type
```{r}
wetland = clean_wetlands
wetland$System_type = "Wetland"
names(wetland)[1] = "System_name"
names(wetland)[9] ="OCb_whole_system"

big_lakes = subset(clean_lakes, select = c(System_name, System_type, Lat, Long, OCb_whole_system, BIOME))
wetlandz = subset(wetland, select = c(System_name, System_type, Lat, Long, OCb_whole_system, BIOME))

all_lentic = rbind(wetlandz, big_lakes)

#make sure biome is a factor
all_lentic$BIOME = as.factor(all_lentic$BIOME)

#compare the biomes with system type as a random effect
lentic_biome_mod = lmer(log10(OCb_whole_system) ~ BIOME + (1|System_type), data = all_lentic)
summary(lentic_biome_mod)
emmeans(lentic_biome_mod, pairwise ~ BIOME)

#and compare burial rates by system type with biome as a random effect
system_type_mod = lmer(log10(OCb_whole_system) ~ System_type + (1|BIOME), data = all_lentic)
summary(system_type_mod)
emmeans(system_type_mod, pairwise~System_type)

#boxplot of burial by biome
biome.colors = c("1" = "#809B82",
           "2" = "#84bb8e",
           "3" = "#81d4a5",
           "4" = "#c8e4a3",
           "5" = "#97b5bc",
           "6" = "#b1cbe5",
           "7" = "#b6a47f",
           "8" = "#d1c383",
           "9" = "#e5e184",
           "10" = "#F6F780",
           "11" = "#DCE7F5",
           "12" = "#E4B692",
           "13" = "#F6CCA2",
           "98" = "#8BB9E6")

biomes$BIOME = as.factor(biomes$BIOME)

lake$BIOME = as.factor(lake$BIOME)
reservoir$BIOME = as.factor(reservoir$BIOME)
wetland$BIOME = as.factor(wetland$BIOME)
pond$BIOME = as.factor(pond$BIOME)

require(scales)
biome_box = ggplot()+
  geom_boxplot(data = all_lentic, aes(x = BIOME, y = OCb_whole_system),color = "black", alpha = 1, outlier.shape = NA)+
  geom_jitter(data = lake, aes(x = BIOME, y = OCb_whole_system, color = BIOME), shape = 19, width = 0.2)+
  geom_jitter(data = reservoir, aes(x = BIOME, y = OCb_whole_system, color = BIOME), shape = 17, width = 0.2)+
  geom_jitter(data = wetland, aes(x = BIOME, y = OCb_whole_system, color = BIOME), shape = 15, width = 0.2)+
  geom_jitter(data = pond, aes(x = BIOME, y = OCb_whole_system, color = BIOME, fill = BIOME), shape = 23, width = 0.2)+
  geom_boxplot(data = all_lentic, aes(x = BIOME, y = OCb_whole_system),color = "black", alpha = 0, outlier.shape = NA)+
  scale_color_manual(values = biome.colors)+
  scale_fill_manual(values = biome.colors)+
  theme_classic()+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_discrete(labels = c("Tropical & Subtropical Moist Broadleaf Forest",
                               "Tropical and subtropical dry broadleaf forest",
                               "Tropical & Subtropical Coniferous Forest",
                               "Temperate Broadleaf & Mixed Forest",
                               "Temperate Coniferous Forest",
                               "Boreal Forest & Taiga",
                               "Tropical & Subtropical Grasslands, Savanna, and Shrubland",
                               "Temperate Grasslands, Savanna, and Shrubland",
                               "Flooded Grasslands, Savanna, and Shrubland",
                               "Montane Grasslands and Shrubland",
                               "Tundra",
                               "Mediterranean Forest",
                               "Desert & Xeric Scrubs",
                               "Lakes"))+
  labs(y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_blank(),
         axis.text.y =  element_text(size = 7,colour = "black"),
         axis.title.y = element_markdown(size = 7, colour = "black"),
         axis.title.x = element_blank())+
  theme(legend.position = "None")
biome_box

#and a boxplot comparing system type
system_type_box = ggplot()+
  geom_jitter(data = lake, aes(x = System_type, y = OCb_whole_system, color = BIOME), shape = 19, width = 0.2)+
  geom_jitter(data = reservoir, aes(x = System_type, y = OCb_whole_system, color = BIOME), shape = 17, width = 0.2)+
  geom_jitter(data = wetland, aes(x = System_type, y = OCb_whole_system, color = BIOME), shape = 15, width = 0.2)+
  geom_jitter(data = pond, aes(x = System_type, y = OCb_whole_system, color = BIOME, fill = BIOME), shape = 23, width = 0.2)+
  geom_boxplot(data = all_lentic, aes(x = System_type, y = OCb_whole_system),color = "black", alpha = 0, outlier.shape = NA)+
  scale_color_manual(values = biome.colors)+
  scale_fill_manual(values = biome.colors)+
  theme_classic()+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_discrete(limits = c("Lake", "Reservoir", "Pond", "Wetland"))+
  labs(y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_blank(),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_blank())+
  theme(legend.position = "None")
  
system_type_box

library(patchwork)
system_biome_boxplot = biome_box + system_type_box +
  plot_layout(ncol = 2, widths = c(1,0.28571429), guides = NULL)+
  #plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
system_biome_boxplot

system_biome_boxplot[[2]] = system_biome_boxplot[[2]] + theme(axis.text.y = element_blank(),
                                        axis.title.y = element_blank())

system_biome_boxplot  
    
ggsave(filename = "system_biome_boxplot.png", plot = system_biome_boxplot, width = 180, height = 70, units = "mm")
```


Get all the summary statistics for each system type by biome:
```{r}
lake_reservoir_pond_summary = clean_lakes %>%
  group_by(System_type) %>%
  dplyr::summarize_at(vars(OCb_whole_system),
                      list(n = length,
                           median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
lake_reservoir_pond_summary

#and by biome
lake_reservoir_pond_biome_summary = clean_lakes %>%
  group_by(System_type, BIOME) %>%
  dplyr::summarize_at(vars(OCb_whole_system),
                      list(n = length,
                           median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
lake_reservoir_pond_biome_summary

wetland_summary = clean_wetlands %>%
  group_by(BIOME) %>%
  dplyr::summarize_at(vars(c_sequest_g_m2_y1),
                      list(n = length,
                           median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
wetland_summary

length(clean_wetlands$c_sequest_g_m2_y1)
median(clean_wetlands$c_sequest_g_m2_y1)
quantile(clean_wetlands$c_sequest_g_m2_y1)
mean(clean_wetlands$c_sequest_g_m2_y1)
sd(clean_wetlands$c_sequest_g_m2_y1)
min(clean_wetlands$c_sequest_g_m2_y1)
max(clean_wetlands$c_sequest_g_m2_y1)


###and all the systems together
lentic_summary = all_lentic %>%
  group_by(BIOME) %>%
  dplyr::summarize_at(vars(OCb_whole_system),
                      list(n = length,
                           median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
lentic_summary

length(all_lentic$OCb_whole_system)
median(all_lentic$OCb_whole_system)
quantile(all_lentic$OCb_whole_system)
mean(all_lentic$OCb_whole_system)
sd(all_lentic$OCb_whole_system)
min(all_lentic$OCb_whole_system)
max(all_lentic$OCb_whole_system)

```

Make the figures for the basic regressions investigating how variables might predict OC burial

Start with lakes >= 0.1km2
```{r}
lake = subset(clean_lakes, System_type == "Lake" )
lake$BIOME = as.factor(lake$BIOME)

biome.colors = c("1" = "#809B82",
           "2" = "#84bb8e",
           "3" = "#81d4a5",
           "4" = "#c8e4a3",
           "5" = "#97b5bc",
           "6" = "#b1cbe5",
           "7" = "#b6a47f",
           "8" = "#d1c383",
           "9" = "#e5e184",
           "10" = "#F6F780",
           "11" = "#DCE7F5",
           "12" = "#E4B692",
           "13" = "#F6CCA2",
           "98" = "#8BB9E6")

#lake area as a predictor of OC burial
options(na.action = "na.omit")
lake_area_bury = lm(log10(OCb_whole_system) ~ log10(lake_area_km2), data = lake)
summary(lake_area_bury)

require(scales)
lake_area_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = lake_area_km2, y = OCb_whole_system, color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Lake Area (km<sup>2</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.11969, intercept = 1.608, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10')+
  annotate('text', label = "paste(italic(r)^2, \" = 0.05  p < 0.001\")", parse = TRUE, x = 0.1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_area_bury_plot

#latitude as a predictor of OC burial
lake_lat_bury = lm(log10(OCb_whole_system) ~ abs(Lat), data = lake)
summary(lake_lat_bury)

lake_latitude_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = abs(Lat), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.003681, intercept = 1.696, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.01  p = 0.017\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
lake_latitude_bury_plot

#elevation as a predictor of OC burial
lake_elev_bury = lm(log10(OCb_whole_system) ~ elevation_km, data = lake)
summary(lake_elev_bury)

lake_elevation_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = elevation_km, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.17913, intercept = 1.65558, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.08  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_elevation_bury_plot

#maximum depth
lake_max_depth_bury = lm(log10(OCb_whole_system) ~ log10(max_depth_m), data = lake)
summary(lake_max_depth_bury)

lake_max_depth_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = (max_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Maximum Depth (m)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.38994, intercept = 1.89073, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.12  p < 0.001\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_max_depth_bury_plot

#mean depth
lake_mean_depth_bury = lm(log10(OCb_whole_system) ~ log10(mean_depth_m), data = lake)
summary(lake_mean_depth_bury)

lake_mean_depth_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = (mean_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Depth (m)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.37574, intercept = 1.41333, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.08  p < 0.001\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
lake_mean_depth_bury_plot

#N fertilizer use
lake_n_fert_bury = lm(log10(OCb_whole_system) ~ log10(n_fert_kg_ha + 0.000001), data = lake)
summary(lake_n_fert_bury)

lake_n_fert_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = (n_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.082713, intercept = 1.603777, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10,100), labels =  c("0.001", "0.1", "1", "10", "100"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.13  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_n_fert_bury_plot

#P fertilizer use
lake_p_fert_bury = lm(log10(OCb_whole_system) ~ log10(p_fert_kg_ha + 0.000001), data = lake)
summary(lake_p_fert_bury)

lake_p_fert_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = (p_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.08699, intercept = 1.65738, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10), labels =  c("0.001", "0.1", "1", "10"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.13  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_p_fert_bury_plot

#mean annual temperature
lake_temp_bury = lm(log10(OCb_whole_system) ~ mean_annual_temp_c, data = lake)
summary(lake_temp_bury)

lake_temp_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = mean_annual_temp_c, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.023338, intercept = 1.366649, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.08  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
lake_temp_bury_plot

#annual precipitation
lake$cm_precip = lake$annual_precip / 10
lake_precip_bury = lm(log10(OCb_whole_system) ~ log10(cm_precip), data = lake)
summary(lake_precip_bury)

lake_precip_bury_plot = ggplot()+
  geom_point(data = lake, aes(x = cm_precip, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.55517, intercept = 0.49825, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.05  p < 0.001\")", parse = TRUE, x = 10, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
lake_precip_bury_plot

library(patchwork)
lake_c_bury_lm_panel = lake_area_bury_plot + lake_latitude_bury_plot + lake_elevation_bury_plot + lake_max_depth_bury_plot +
  lake_mean_depth_bury_plot + lake_n_fert_bury_plot + lake_p_fert_bury_plot + lake_temp_bury_plot + lake_precip_bury_plot +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
lake_c_bury_lm_panel

lake_c_bury_lm_panel[[2]] = 
  lake_c_bury_lm_panel[[2]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel[[3]] = 
  lake_c_bury_lm_panel[[3]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel[[5]] = 
  lake_c_bury_lm_panel[[5]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel[[6]] = 
  lake_c_bury_lm_panel[[6]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel[[8]] = 
  lake_c_bury_lm_panel[[8]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel[[9]] = 
  lake_c_bury_lm_panel[[9]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lake_c_bury_lm_panel

ggsave(filename = "lake_c_bury_lm_panel.png", plot = lake_c_bury_lm_panel, width = 180, height = 180, units = "mm")
```


Repeat for impoundments >=0.1 km2
```{r}
impoundment = subset(clean_lakes, System_type == "Reservoir" )
impoundment$BIOME = as.factor(impoundment$BIOME)

biome.colors = c("1" = "#809B82",
           "2" = "#84bb8e",
           "3" = "#81d4a5",
           "4" = "#c8e4a3",
           "5" = "#97b5bc",
           "6" = "#b1cbe5",
           "7" = "#b6a47f",
           "8" = "#d1c383",
           "9" = "#e5e184",
           "10" = "#F6F780",
           "11" = "#DCE7F5",
           "12" = "#E4B692",
           "13" = "#F6CCA2",
           "98" = "#8BB9E6")

#impoundment area as a predictor of OC burial
options(na.action = "na.omit")
impoundment_area_bury = lm(log10(OCb_whole_system) ~ log10(lake_area_km2), data = impoundment)
summary(impoundment_area_bury)

require(scales)
impoundment_area_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = lake_area_km2, y = OCb_whole_system, color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Impoundment Area (km<sup>2</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.2667, intercept = 2.2857, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10')+
  annotate('text', label = "paste(italic(r)^2, \" = 0.11  p = 0.016\")", parse = TRUE, x = 0.1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_area_bury_plot

#latitude as a predictor of OC burial
impoundment_lat_bury = lm(log10(OCb_whole_system) ~ abs(Lat), data = impoundment)
summary(impoundment_lat_bury)

impoundment_latitude_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = abs(Lat), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = -0.003681, intercept = 1.696, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.05  p = 0.069\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
impoundment_latitude_bury_plot

#elevation as a predictor of OC burial
impoundment_elev_bury = lm(log10(OCb_whole_system) ~ elevation_km, data = impoundment)
summary(impoundment_elev_bury)

impoundment_elevation_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = elevation_km, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.6461, intercept = 2.5345, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.26  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_elevation_bury_plot

#maximum depth
impoundment_max_depth_bury = lm(log10(OCb_whole_system) ~ log10(max_depth_m), data = impoundment)
summary(impoundment_max_depth_bury)

impoundment_max_depth_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = (max_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Maximum Depth (m)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = -0.38994, intercept = 1.89073, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.00  p = 0.496\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_max_depth_bury_plot

#mean depth
impoundment_mean_depth_bury = lm(log10(OCb_whole_system) ~ log10(mean_depth_m), data = impoundment)
summary(impoundment_mean_depth_bury)

impoundment_mean_depth_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = (mean_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Depth (m)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = -0.37574, intercept = 1.41333, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.00  p = 0.904\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
impoundment_mean_depth_bury_plot

#N fertilizer use
impoundment_n_fert_bury = lm(log10(OCb_whole_system) ~ log10(n_fert_kg_ha + 0.000001), data = impoundment)
summary(impoundment_n_fert_bury)

impoundment_n_fert_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = (n_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = 0.082713, intercept = 1.603777, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10,100), labels =  c("0.001", "0.1", "1", "10", "100"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.04  p = 0.111\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_n_fert_bury_plot

#P fertilizer use
impoundment_p_fert_bury = lm(log10(OCb_whole_system) ~ log10(p_fert_kg_ha + 0.000001), data = impoundment)
summary(impoundment_p_fert_bury)

impoundment_p_fert_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = (p_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = 0.08699, intercept = 1.65738, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10), labels =  c("0.001", "0.1", "1", "10"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.05  p = 0.066\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_p_fert_bury_plot

#mean annual temperature
impoundment_temp_bury = lm(log10(OCb_whole_system) ~ mean_annual_temp_c, data = impoundment)
summary(impoundment_temp_bury)

impoundment_temp_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = mean_annual_temp_c, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = 0.023338, intercept = 1.366649, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.00  p = 0.497\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
impoundment_temp_bury_plot

#annual precipitation
impoundment$cm_precip = impoundment$annual_precip / 10
impoundment_precip_bury = lm(log10(OCb_whole_system) ~ log10(cm_precip), data = impoundment)
summary(impoundment_precip_bury)

impoundment_precip_bury_plot = ggplot()+
  geom_point(data = impoundment, aes(x = cm_precip, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = 0.55517, intercept = 0.49825, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.00  p = 0.325\")", parse = TRUE, x = 10, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
impoundment_precip_bury_plot

library(patchwork)
impoundment_c_bury_lm_panel = impoundment_area_bury_plot + impoundment_latitude_bury_plot + impoundment_elevation_bury_plot + impoundment_max_depth_bury_plot +
  impoundment_mean_depth_bury_plot + impoundment_n_fert_bury_plot + impoundment_p_fert_bury_plot + impoundment_temp_bury_plot + impoundment_precip_bury_plot +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
impoundment_c_bury_lm_panel

impoundment_c_bury_lm_panel[[2]] = 
  impoundment_c_bury_lm_panel[[2]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel[[3]] = 
  impoundment_c_bury_lm_panel[[3]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel[[5]] = 
  impoundment_c_bury_lm_panel[[5]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel[[6]] = 
  impoundment_c_bury_lm_panel[[6]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel[[8]] = 
  impoundment_c_bury_lm_panel[[8]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel[[9]] = 
  impoundment_c_bury_lm_panel[[9]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

impoundment_c_bury_lm_panel

ggsave(filename = "impoundment_c_bury_lm_panel.png", plot = impoundment_c_bury_lm_panel, width = 180, height = 180, units = "mm")
```


And ponds and lakes < 0.1km2
```{r}
pond = subset(clean_lakes, System_type == "Pond" )
pond$BIOME = as.factor(pond$BIOME)

biome.colors = c("1" = "#809B82",
           "2" = "#84bb8e",
           "3" = "#81d4a5",
           "4" = "#c8e4a3",
           "5" = "#97b5bc",
           "6" = "#b1cbe5",
           "7" = "#b6a47f",
           "8" = "#d1c383",
           "9" = "#e5e184",
           "10" = "#F6F780",
           "11" = "#DCE7F5",
           "12" = "#E4B692",
           "13" = "#F6CCA2",
           "98" = "#8BB9E6")

#pond area as a predictor of OC burial
options(na.action = "na.omit")
pond_area_bury = lm(log10(OCb_whole_system) ~ log10(lake_area_km2), data = pond)
summary(pond_area_bury)

require(scales)
pond_area_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = (lake_area_km2*1000000), y = OCb_whole_system, color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Pond Area (m<sup>2</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = -0.2667, intercept = 2.2857, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10')+
  annotate('text', label = "paste(italic(r)^2, \" = 0.01  p = 0.132\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_area_bury_plot

#latitude as a predictor of OC burial
pond_lat_bury = lm(log10(OCb_whole_system) ~ abs(Lat), data = pond)
summary(pond_lat_bury)

pond_latitude_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = abs(Lat), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  #geom_abline(slope = -0.003681, intercept = 1.696, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.01  p = 0.113\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
pond_latitude_bury_plot

#elevation as a predictor of OC burial
pond_elev_bury = lm(log10(OCb_whole_system) ~ elevation_km, data = pond)
summary(pond_elev_bury)

pond_elevation_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = elevation_km, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.30329, intercept = 1.93602, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.25  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_elevation_bury_plot

#maximum depth
pond_max_depth_bury = lm(log10(OCb_whole_system) ~ log10(max_depth_m), data = pond)
summary(pond_max_depth_bury)

pond_max_depth_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = (max_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Maximum Depth (m)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.54343, intercept = 2.01237, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.16  p < 0.001\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_max_depth_bury_plot

#mean depth
pond_mean_depth_bury = lm(log10(OCb_whole_system) ~ log10(mean_depth_m), data = pond)
summary(pond_mean_depth_bury)

pond_mean_depth_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = (mean_depth_m), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Depth (m)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.7090, intercept = 1.648, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.27  p < 0.001\")", parse = TRUE, x = 1, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
pond_mean_depth_bury_plot

#N fertilizer use
pond_n_fert_bury = lm(log10(OCb_whole_system) ~ log10(n_fert_kg_ha + 0.000001), data = pond)
summary(pond_n_fert_bury)

pond_n_fert_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = (n_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.14111, intercept = 1.73768, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10,100), labels =  c("0.001", "0.1", "1", "10", "100"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.23  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_n_fert_bury_plot

#P fertilizer use
pond_p_fert_bury = lm(log10(OCb_whole_system) ~ log10(p_fert_kg_ha + 0.000001), data = pond)
summary(pond_p_fert_bury)

pond_p_fert_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = (p_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.16343, intercept = 1.85124, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10), labels =  c("0.001", "0.1", "1", "10"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.27  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_p_fert_bury_plot

#mean annual temperature
pond_temp_bury = lm(log10(OCb_whole_system) ~ mean_annual_temp_c, data = pond)
summary(pond_temp_bury)

pond_temp_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = mean_annual_temp_c, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.057108, intercept = 1.292496, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.24  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
pond_temp_bury_plot

#annual precipitation
pond$cm_precip = pond$annual_precip / 10
pond_precip_bury = lm(log10(OCb_whole_system) ~ log10(cm_precip), data = pond)
summary(pond_precip_bury)

pond_precip_bury_plot = ggplot()+
  geom_point(data = pond, aes(x = cm_precip, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = "OC Burial Rate (g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.6004, intercept = 0.4913, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', labels = comma)+
  annotate('text', label = "paste(italic(r)^2, \" = 0.03  p = 0.006\")", parse = TRUE, x = 10, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
pond_precip_bury_plot

pond_c_bury_lm_panel = pond_area_bury_plot + pond_latitude_bury_plot + pond_elevation_bury_plot + pond_max_depth_bury_plot +
  pond_mean_depth_bury_plot + pond_n_fert_bury_plot + pond_p_fert_bury_plot + pond_temp_bury_plot + pond_precip_bury_plot +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
pond_c_bury_lm_panel

pond_c_bury_lm_panel[[2]] = 
  pond_c_bury_lm_panel[[2]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel[[3]] = 
  pond_c_bury_lm_panel[[3]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel[[5]] = 
  pond_c_bury_lm_panel[[5]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel[[6]] = 
  pond_c_bury_lm_panel[[6]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel[[8]] = 
  pond_c_bury_lm_panel[[8]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel[[9]] = 
  pond_c_bury_lm_panel[[9]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

pond_c_bury_lm_panel

ggsave(filename = "pond_c_bury_lm_panel.png", plot = pond_c_bury_lm_panel, width = 180, height = 180, units = "mm")
```


And look at linear relationships for wetlands:
```{r}
#latitude as a predictor of OC burial
wetland_lat_bury = lm(log10(OCb_whole_system) ~ abs(Lat), data = wetland)
summary(wetland_lat_bury)

clean_wetlands$BIOME = as.factor(clean_wetlands$BIOME)

require(scales)
wet_latitude_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = abs(Lat), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.006365, intercept = 1.983694, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.06  p < 0.001\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
wet_latitude_bury_plot

#elevation as a predictor of OC burial
wet_elev_bury = lm(log10(OCb_whole_system) ~ elevation_km, data = wetland)
summary(wet_elev_bury)

wet_elevation_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = elevation_km, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = -0.05753, intercept = 1.78661, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.02  p = 0.046\")", parse = TRUE, x = 0, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
wet_elevation_bury_plot

#N fertilizer use
wet_n_fert_bury = lm(log10(OCb_whole_system) ~ log10(n_fert_kg_ha + 0.000001), data = wetland)
summary(wet_n_fert_bury)

wet_n_fert_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = (n_fert_kg_ha + 0.000001), y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.11872, intercept = 1.79573, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.24  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10,100), labels =  c("0.001", "0.1", "1", "10", "100"))+
  theme(legend.position = "None")
  
wet_n_fert_bury_plot

#P fertilizer use

log_p_rel = lm(log10(OCb_whole_system) ~ log10(p_fert_kg_ha + 0.000001), data = wetland)
summary(log_p_rel)

wet_p_fert_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = p_fert_kg_ha, y = (OCb_whole_system + 0.000001), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.11613, intercept = 1.88454, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  scale_x_continuous(trans = 'log10', breaks = c(0.001, 0.1, 1, 10), labels =  c("0.001", "0.1", "1", "10"))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.24  p < 0.001\")", parse = TRUE, x = 0.001, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
wet_p_fert_bury_plot

#mean annual temperature
wet_temp_bury = lm(log10(OCb_whole_system) ~ mean_annual_temp_c, data = wetland)
summary(wet_temp_bury)

wet_temp_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = mean_annual_temp_c, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.01490, intercept = 1.60840, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.12  p < 0.001\")", parse = TRUE, x = -10, y = 10000, size = 2.822, hjust = 0)+
  theme(legend.position = "None")
  
wet_temp_bury_plot

#mean monthly precipitation
wetland$precip_cm = wetland$annual_precip / 10
wet_precip_bury = lm(log10(OCb_whole_system) ~ log10(precip_cm), data = wetland)
summary(wet_precip_bury)

wet_precip_bury_plot = ggplot()+
  geom_point(data = wetland, aes(x = precip_cm, y = (OCb_whole_system), color = BIOME))+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8,colour = "black"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  geom_abline(slope = 0.4131, intercept = 0.9429, size = 1, color = "black")+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "paste(italic(r)^2, \" = 0.06  p < 0.001\")", parse = TRUE, x = 5, y = 10000, size = 2.822, hjust = 0)+
  scale_x_continuous(trans = 'log10')+
  theme(legend.position = "None")
wet_precip_bury_plot

#test between peat/not
peat = subset(wetland, peat_yn == "y")
no_peat = subset(wetland, peat_yn =="n")
peat_bury_dat = rbind(peat, no_peat)

mean(peat$OCb_whole_system)
sd(peat$OCb_whole_system)
mean(no_peat$OCb_whole_system)
sd(no_peat$OCb_whole_system)
  
wet_peat_bury = lmer(log10(OCb_whole_system) ~ peat_yn + (1|BIOME), data = peat_bury_dat)
summary(wet_peat_bury)
emmeans(wet_peat_bury, pairwise~peat_yn)

wet_peat_bury_box = ggplot()+
  geom_boxplot(data = peat_bury_dat, aes(x = peat_yn, y = OCb_whole_system),color = "black", alpha = 0, outlier.shape = NA)+
  geom_jitter(data = peat_bury_dat, aes(x = peat_yn, y = OCb_whole_system, color = BIOME), width = 0.2)+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_discrete(labels = c("Mineral",
                               "Peat"))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_blank())+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "p = 0.009", x = 1, y = 10000, size = 2.822, hjust = 1)+
  theme(legend.position = "None")
wet_peat_bury_box

##and vegetation type
emergent = subset(wetland, veg_category == "emergent")
shrub = subset(wetland, veg_category == "shrub")
forest = subset(wetland, veg_category == "forest")

mean(emergent$OCb_whole_system)
sd(emergent$OCb_whole_system)
mean(shrub$OCb_whole_system)
sd(shrub$OCb_whole_system)
mean(forest$OCb_whole_system)
sd(forest$OCb_whole_system)

veg_dat = rbind(emergent, shrub, forest)

wet_vegtype_bury = lmer(log10(OCb_whole_system) ~ veg_category + (1|BIOME), data = veg_dat)
summary(wet_vegtype_bury)
emmeans(wet_vegtype_bury, pairwise~veg_category)

wet_veg_bury_box = ggplot()+
  geom_boxplot(data = veg_dat, aes(x = veg_category, y = OCb_whole_system),color = "black", alpha = 0, outlier.shape = NA)+
  geom_jitter(data = veg_dat, aes(x = veg_category, y = OCb_whole_system, color = BIOME), width = 0.2)+
  scale_color_manual(values = biome.colors)+
  theme_classic()+
  labs(y = "OC Burial Rate<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_discrete(labels = c("Emergent",
                               "Forest",
                              "Shrub"))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_blank())+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  scale_y_continuous(trans = 'log10', labels = comma, breaks = c(0.01, 0.1, 1, 10, 100, 1000, 10000))+
  annotate('text', label = "a", x = 1, y = 10000, size = 2.822, hjust = 1)+
  annotate('text', label = "a", x = 2, y = 10000, size = 2.822, hjust = 1)+
  annotate('text', label = "a", x = 3, y = 10000, size = 2.822, hjust = 1)+
  theme(legend.position = "None")
wet_veg_bury_box

wet_c_bury_lm_panel = wet_latitude_bury_plot + wet_elevation_bury_plot + wet_n_fert_bury_plot + 
  wet_p_fert_bury_plot + wet_temp_bury_plot + wet_precip_bury_plot + wet_peat_bury_box + wet_veg_bury_box +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
wet_c_bury_lm_panel

wet_c_bury_lm_panel[[2]] = 
  wet_c_bury_lm_panel[[2]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

wet_c_bury_lm_panel[[3]] = 
  wet_c_bury_lm_panel[[3]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

wet_c_bury_lm_panel[[5]] = 
  wet_c_bury_lm_panel[[5]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

wet_c_bury_lm_panel[[6]] = 
  wet_c_bury_lm_panel[[6]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

wet_c_bury_lm_panel[[8]] = 
  wet_c_bury_lm_panel[[8]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

wet_c_bury_lm_panel

ggsave(filename = "wet_c_bury_lm_panel.png", plot = wet_c_bury_lm_panel, width = 180, height = 180, units = "mm")
```


Check for correlations between predictor variables prior to beginning random forest scaling:
```{r}
clean_lakes$cm_precip = clean_lakes$annual_precip/10
lakes_corr = subset(clean_lakes, select = c(Lat, Long, OCb_whole_system,
                                            elevation_km, n_fert_kg_ha, p_fert_kg_ha,
                                            mean_annual_temp_c, cm_precip))


wetland$cm_precip = wetland$annual_precip/10
wetlands_corr = subset(wetland, select = c(Lat, Long, OCb_whole_system,
                                            elevation_km, n_fert_kg_ha, p_fert_kg_ha,
                                           mean_annual_temp_c, cm_precip))

big_corr_dat = rbind(lakes_corr, wetlands_corr)
big_corr_dat
big_corr_dat2 = as.data.frame(na.omit(big_corr_dat))
big_corr_dat2

big_corr_table = rcorr(as.matrix(big_corr_dat2), type = "pearson")
big_corr_table

options(scipen = 999)
big_corr_table$r
big_corr_table$P

write.csv(big_corr_table$r, "raster_cor_rvals.csv", row.names = T)
write.csv(big_corr_table$P, "raster_cor_pvals.csv", row.names = T)

#look at just lakes/impoundments and their "bonus" data
lakes_corr2 = subset(clean_lakes, select = c(Lat, Long, OCb_whole_system,
                                            elevation_km, n_fert_kg_ha, p_fert_kg_ha,
                                            mean_annual_temp_c, cm_precip, 
                                            lake_area_km2, max_depth_m, mean_depth_m))

lakes_corr_table = rcorr(as.matrix(lakes_corr2), type = "pearson")
lakes_corr_table

lakes_corr_table$r
lakes_corr_table$P

write.csv(lakes_corr_table$r, "lakes_cor_rvals.csv", row.names = T)
write.csv(lakes_corr_table$P, "lakes_cor_pvals.csv", row.names = T)
```



Train the random forest model for impounmdnet >= 0.1 km2 OC burial
```{r}
reservoir_forest_dat = subset(clean_lakes, System_type == "Reservoir")

#get all the columns properly transformed
reservoir_forest_dat$log_area = log10(reservoir_forest_dat$lake_area_km2)
reservoir_forest_dat$log_max_depth = log10(reservoir_forest_dat$max_depth_m)
reservoir_forest_dat$log_mean_depth = log10(reservoir_forest_dat$mean_depth_m)
reservoir_forest_dat$abs_lat = abs(reservoir_forest_dat$Lat)
reservoir_forest_dat$log_n_fert = log10(reservoir_forest_dat$n_fert_kg_ha + 0.000000001)
reservoir_forest_dat$log_p_fert = log10(reservoir_forest_dat$p_fert_kg_ha + 0.000000001)
reservoir_forest_dat$log_precip = log10(reservoir_forest_dat$annual_precip/10)
reservoir_forest_dat$log_burial = log10(reservoir_forest_dat$OCb_whole_system)

reservoir_forest_dat2 = reservoir_forest_dat %>% dplyr::select(log_burial, log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#and make the training/testing dataset:
set.seed(17)
reservoir_forest_dat3 = na.omit(reservoir_forest_dat2)
reservoir_split = initial_split(reservoir_forest_dat3, prop = 0.8)

#find the best random forest model parameters
rf_grid <- grid_regular(
  mtry(range = c(1,7)),
  min_n(range = c(1, 10)),
  trees(range = c(500,2000)),
  levels = 10
)

tune_spec <- rand_forest(
  mtry = tune(),
  trees = tune(),
  min_n = tune()) %>%
  set_mode("regression") %>%
  set_engine("ranger")

reservoir_recipe <- training(reservoir_split) %>%
  recipe(log_burial ~ .)

tune_wf <- workflow() %>%
  add_recipe(reservoir_recipe) %>%
  add_model(tune_spec)

set.seed(17)
trees_folds <- vfold_cv(training(reservoir_split), v = 5)

tune_res <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20,
  control = tune::control_grid(verbose = TRUE)
)

tune_res %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, min_n, mtry, trees) %>%
  pivot_longer(min_n:trees,
               values_to = "value",
               names_to = "parameter") %>%
  ggplot(aes(value, exp(mean), color = parameter)) +
  geom_point(show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "rmse")

select_best(tune_res)
# ok, so the best random forest model for reservoirs has:
#trees: 1018
#minimum node size = 2
#mtry = 2

# Run the random forest:
set.seed(17)
options(na.action = "na.omit")

reservoir_train = training(reservoir_split)
reservoir_test = testing(reservoir_split)

reservoir_rf = ranger(log_burial ~ ., data = reservoir_train,
                      mtry = 2, num.trees = 1018, min.node.size = 2, keep.inbag = TRUE, importance = "impurity")
reservoir_rf
reservoir_rf$variable.importance

reservoir_rf_predict = predict(reservoir_rf, reservoir_train, type = "se", se.method = "infjack")
reservoir_rf_predict
reservoir_rf_predict$predictions
reservoir_rf_predict$se
```


Make the probability density function plots for the impoundment model
```{r}
#this uses the "pdp" library
res_par_area_plot_dat = pdp::partial(reservoir_rf, pred.var = c("log_area"), chull = TRUE)
res_plot_log_area = ggplot(data = res_par_area_plot_dat, aes(x = log_area, y = yhat))+
  theme_classic()+
  labs(x = "Log Surface Area (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_text(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_log_area

res_par_abslat_plot_dat = pdp::partial(reservoir_rf, pred.var = c("abs_lat"), chull = TRUE)
res_plot_abslat = ggplot(data = res_par_abslat_plot_dat, aes(x = abs_lat, y = yhat))+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_abslat

res_par_lognfert_plot_dat = pdp::partial(reservoir_rf, pred.var = c("log_n_fert"), chull = TRUE)
res_plot_lognfert = ggplot(data = res_par_lognfert_plot_dat, aes(x = 10^log_n_fert, y = yhat))+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_lognfert

res_par_logpfert_plot_dat = pdp::partial(reservoir_rf, pred.var = c("log_p_fert"), chull = TRUE)
res_plot_logpfert = ggplot(data = res_par_logpfert_plot_dat, aes(x = 10^log_p_fert, y = yhat))+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_logpfert

res_par_log_precip_plot_dat = pdp::partial(reservoir_rf, pred.var = c("log_precip"), chull = TRUE)
res_plot_logprecip = ggplot(data = res_par_log_precip_plot_dat, aes(x = 10^log_precip, y = yhat))+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_logprecip

res_par_elevation_plot_dat = pdp::partial(reservoir_rf, pred.var = c("elevation_km"), chull = TRUE)
res_plot_elevation = ggplot(data = res_par_elevation_plot_dat, aes(x = elevation_km, y = yhat))+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_elevation

res_par_temp_plot_dat = pdp::partial(reservoir_rf, pred.var = c("mean_annual_temp_c"), chull = TRUE)
res_plot_temp = ggplot(data = res_par_temp_plot_dat, aes(x = mean_annual_temp_c, y = yhat))+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
res_plot_temp

res_pdp_plot = res_plot_log_area + res_plot_abslat + res_plot_lognfert + res_plot_logpfert + res_plot_logprecip + res_plot_elevation + res_plot_temp +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
res_pdp_plot

ggsave(filename = "res_pdp_plot.png", plot = res_pdp_plot, width = 180, height = 180, units = "mm")
```



Repeat the model identification and PDP plots for lakes >=0.1km2
```{r}
lake_forest_dat = subset(clean_lakes, System_type == "Lake")

#get all the columns properly transformed
lake_forest_dat$log_area = log10(lake_forest_dat$lake_area_km2)
lake_forest_dat$log_max_depth = log10(lake_forest_dat$max_depth_m)
lake_forest_dat$log_mean_depth = log10(lake_forest_dat$mean_depth_m)
lake_forest_dat$abs_lat = abs(lake_forest_dat$Lat)
lake_forest_dat$log_n_fert = log10(lake_forest_dat$n_fert_kg_ha + 0.000000001)
lake_forest_dat$log_p_fert = log10(lake_forest_dat$p_fert_kg_ha + 0.000000001)
lake_forest_dat$log_precip = log10(lake_forest_dat$annual_precip/10)
lake_forest_dat$log_burial = log10(lake_forest_dat$OCb_whole_system)

lake_forest_dat2 = lake_forest_dat %>% dplyr::select(log_burial, log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#and make the training/testing dataset:
set.seed(17)
lake_forest_dat3 = na.omit(lake_forest_dat2)
lake_split = initial_split(lake_forest_dat3, prop = 0.8)

#find the best model configuration
rf_grid <- grid_regular(
  mtry(range = c(1,7)),
  min_n(range = c(1, 10)),
  trees(range = c(500,2000)),
  levels = 10
)

tune_spec <- rand_forest(
  mtry = tune(),
  trees = tune(),
  min_n = tune()) %>%
  set_mode("regression") %>%
  set_engine("ranger")

lake_recipe <- training(lake_split) %>%
  recipe(log_burial ~ .)

tune_wf <- workflow() %>%
  add_recipe(lake_recipe) %>%
  add_model(tune_spec)

set.seed(17)
trees_folds <- vfold_cv(training(lake_split), v = 5)

tune_lake <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20,
  control = tune::control_grid(verbose = TRUE)
)

tune_lake %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, min_n, mtry, trees) %>%
  pivot_longer(min_n:trees,
               values_to = "value",
               names_to = "parameter") %>%
  ggplot(aes(value, exp(mean), color = parameter)) +
  geom_point(show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "rmse")

select_best(tune_lake)
# ok, so the best random forest model for reservoirs has:
#trees: 1778
#minimum node size = 8
#mtry = 2

# Run the random forest:
set.seed(17)
options(na.action = "na.omit")

lake_train = training(lake_split)
lake_test = testing(lake_split)

lake_rf = ranger(log_burial ~ ., data = lake_train,
                      mtry = 2, num.trees = 1778, min.node.size = 8, keep.inbag = TRUE, importance = "impurity")
lake_rf
lake_rf$variable.importance

lake_rf_predict = predict(lake_rf, lake_train, type = "se", se.method = "infjack")
lake_rf_predict$predictions
lake_rf_predict$se

#make the probability density function plots
lake_par_area_plot_dat = pdp::partial(lake_rf, pred.var = c("log_area"), chull = TRUE)
lake_plot_log_area = ggplot(data = lake_par_area_plot_dat, aes(x = log_area, y = yhat))+
  theme_classic()+
  labs(x = "Log Surface Area (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_text(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_log_area

lake_par_abslat_plot_dat = pdp::partial(lake_rf, pred.var = c("abs_lat"), chull = TRUE)
lake_plot_abslat = ggplot(data = lake_par_abslat_plot_dat, aes(x = abs_lat, y = yhat))+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_abslat

lake_par_lognfert_plot_dat = pdp::partial(lake_rf, pred.var = c("log_n_fert"), chull = TRUE)
lake_plot_lognfert = ggplot(data = lake_par_lognfert_plot_dat, aes(x = 10^log_n_fert, y = yhat))+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_lognfert

lake_par_logpfert_plot_dat = pdp::partial(lake_rf, pred.var = c("log_p_fert"), chull = TRUE)
lake_plot_logpfert = ggplot(data = lake_par_logpfert_plot_dat, aes(x = 10^log_p_fert, y = yhat))+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_logpfert

lake_par_log_precip_plot_dat = pdp::partial(lake_rf, pred.var = c("log_precip"), chull = TRUE)
lake_plot_logprecip = ggplot(data = lake_par_log_precip_plot_dat, aes(x = 10^log_precip, y = yhat))+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_logprecip

lake_par_elevation_plot_dat = pdp::partial(lake_rf, pred.var = c("elevation_km"), chull = TRUE)
lake_plot_elevation = ggplot(data = lake_par_elevation_plot_dat, aes(x = elevation_km, y = yhat))+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_elevation

lake_par_temp_plot_dat = pdp::partial(lake_rf, pred.var = c("mean_annual_temp_c"), chull = TRUE)
lake_plot_temp = ggplot(data = lake_par_temp_plot_dat, aes(x = mean_annual_temp_c, y = yhat))+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
lake_plot_temp

lake_pdp_plot = lake_plot_log_area + lake_plot_abslat + lake_plot_lognfert + lake_plot_logpfert + lake_plot_logprecip + lake_plot_elevation + lake_plot_temp +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
lake_pdp_plot

ggsave(filename = "lake_pdp_plot.png", plot = lake_pdp_plot, width = 180, height = 180, units = "mm")
```



Repeat model selection and PDP plots for wetlands
```{r}
wetland_forest_dat = clean_wetlands

#get everything transformed
wetland_forest_dat$abs_lat = abs(wetland_forest_dat$Lat)
wetland_forest_dat$log_n_fert = log10(wetland_forest_dat$n_fert_kg_ha + 0.000000001)
wetland_forest_dat$log_p_fert = log10(wetland_forest_dat$p_fert_kg_ha + 0.000000001)
wetland_forest_dat$log_precip = log10(wetland_forest_dat$annual_precip/10)
wetland_forest_dat$log_burial = log10(wetland_forest_dat$c_sequest_g_m2_y1)

wetland_forest_dat2 = wetland_forest_dat %>% 
  dplyr::select(log_burial, abs_lat, log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#and make the training/testing dataset:
set.seed(17)
wetland_forest_dat3 = na.omit(wetland_forest_dat2)
wetland_split = initial_split(wetland_forest_dat3, prop = 0.8)

#find the best model configuration
rf_grid <- grid_regular(
  mtry(range = c(1,6)),
  min_n(range = c(1, 10)),
  trees(range = c(500,2000)),
  levels = 10
)

tune_spec <- rand_forest(
  mtry = tune(),
  trees = tune(),
  min_n = tune()) %>%
  set_mode("regression") %>%
  set_engine("ranger")

wet_recipe <- training(wetland_split) %>%
  recipe(log_burial ~ .)

tune_wf <- workflow() %>%
  add_recipe(wet_recipe) %>%
  add_model(tune_spec)

set.seed(17)
trees_folds <- vfold_cv(training(wetland_split), v = 5)

tune_wet <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20,
  control = tune::control_grid(verbose = TRUE)
)

tune_wet %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, min_n, mtry, trees) %>%
  pivot_longer(min_n:trees,
               values_to = "value",
               names_to = "parameter") %>%
  ggplot(aes(value, exp(mean), color = parameter)) +
  geom_point(show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "rmse")

select_best(tune_wet)

# ok, so the best random forest model for reservoirs has:
#trees: 920
#minimum node size = 3
#mtry = 2

# Run the random forest:
set.seed(17)
options(na.action = "na.omit")

wetland_train = training(wetland_split)
wetland_test = testing(wetland_split)

wetland_rf = ranger(log_burial ~ ., data = wetland_train,
                      mtry = 2, num.trees = 920, min.node.size = 3, keep.inbag = TRUE, importance = "impurity")
wetland_rf
wetland_rf$variable.importance

wetland_rf_predict = predict(wetland_rf, wetland_train, type = "se", se.method = "infjack")
wetland_rf_predict$predictions
wetland_rf_predict$se

#make the plots
wetland_par_abslat_plot_dat = pdp::partial(wetland_rf, pred.var = c("abs_lat"), chull = TRUE)
wetland_plot_abslat = ggplot(data = wetland_par_abslat_plot_dat, aes(x = abs_lat, y = yhat))+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_abslat

wetland_par_lognfert_plot_dat = pdp::partial(wetland_rf, pred.var = c("log_n_fert"), chull = TRUE)
wetland_plot_lognfert = ggplot(data = wetland_par_lognfert_plot_dat, aes(x = 10^log_n_fert, y = yhat))+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_lognfert

wetland_par_logpfert_plot_dat = pdp::partial(wetland_rf, pred.var = c("log_p_fert"), chull = TRUE)
wetland_plot_logpfert = ggplot(data = wetland_par_logpfert_plot_dat, aes(x = 10^log_p_fert, y = yhat))+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_logpfert

wetland_par_log_precip_plot_dat = pdp::partial(wetland_rf, pred.var = c("log_precip"), chull = TRUE)
wetland_plot_logprecip = ggplot(data = wetland_par_log_precip_plot_dat, aes(x = 10^log_precip, y = yhat))+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_logprecip

wetland_par_elevation_plot_dat = pdp::partial(wetland_rf, pred.var = c("elevation_km"), chull = TRUE)
wetland_plot_elevation = ggplot(data = wetland_par_elevation_plot_dat, aes(x = elevation_km, y = yhat))+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_elevation

wetland_par_temp_plot_dat = pdp::partial(wetland_rf, pred.var = c("mean_annual_temp_c"), chull = TRUE)
wetland_plot_temp = ggplot(data = wetland_par_temp_plot_dat, aes(x = mean_annual_temp_c, y = yhat))+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
wetland_plot_temp

wetland_pdp_plot = wetland_plot_abslat + wetland_plot_lognfert + wetland_plot_logpfert + wetland_plot_logprecip + wetland_plot_elevation + wetland_plot_temp +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
wetland_pdp_plot

ggsave(filename = "wetland_pdp_plot.png", plot = wetland_pdp_plot, width = 180, height = 180, units = "mm")
```


And repeat model selection and PDP plots for ponds and lakes < 0.1 km2
```{r}
pond_forest_dat = subset(clean_lakes, System_type == "Pond")

#get all the columns properly transformed
pond_forest_dat$log_area = log10(pond_forest_dat$lake_area_km2)
pond_forest_dat$log_max_depth = log10(pond_forest_dat$max_depth_m)
pond_forest_dat$log_mean_depth = log10(pond_forest_dat$mean_depth_m)
pond_forest_dat$abs_lat = abs(pond_forest_dat$Lat)
pond_forest_dat$log_n_fert = log10(pond_forest_dat$n_fert_kg_ha + 0.000000001)
pond_forest_dat$log_p_fert = log10(pond_forest_dat$p_fert_kg_ha + 0.000000001)
pond_forest_dat$log_precip = log10(pond_forest_dat$annual_precip/10)
pond_forest_dat$log_burial = log10(pond_forest_dat$OCb_whole_system)

pond_forest_dat2 = pond_forest_dat %>% dplyr::select(log_burial, log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#and make the training/testing dataset:
set.seed(17)
pond_forest_dat3 = na.omit(pond_forest_dat2)
pond_split = initial_split(pond_forest_dat3, prop = 0.8)

#find the best model configuration
rf_grid <- grid_regular(
  mtry(range = c(1,7)),
  min_n(range = c(1, 10)),
  trees(range = c(500,2000)),
  levels = 10
)

tune_spec <- rand_forest(
  mtry = tune(),
  trees = tune(),
  min_n = tune()) %>%
  set_mode("regression") %>%
  set_engine("ranger")

pond_recipe <- training(pond_split) %>%
  recipe(log_burial ~ .)

tune_wf <- workflow() %>%
  add_recipe(pond_recipe) %>%
  add_model(tune_spec)

set.seed(17)
trees_folds <- vfold_cv(training(pond_split), v = 5)

tune_pond <- tune_grid(
  tune_wf,
  resamples = trees_folds,
  grid = 20,
  control = tune::control_grid(verbose = TRUE)
)

tune_pond %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, min_n, mtry, trees) %>%
  pivot_longer(min_n:trees,
               values_to = "value",
               names_to = "parameter") %>%
  ggplot(aes(value, exp(mean), color = parameter)) +
  geom_point(show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "rmse")

select_best(tune_pond)
# ok, so the best random forest model for reservoirs has:
#trees: 1422
#minimum node size = 3
#mtry = 4

# Run the random forest:
set.seed(17)
options(na.action = "na.omit")

pond_train = training(pond_split)
pond_test = testing(pond_split)

pond_rf = ranger(log_burial ~ ., data = pond_train,
                      mtry = 4, num.trees = 1422, min.node.size = 3, keep.inbag = TRUE, importance = "impurity")
pond_rf
pond_rf$variable.importance

pond_rf_predict = predict(pond_rf, pond_train, type = "se", se.method = "infjack")
pond_rf_predict$predictions
pond_rf_predict$se


#and make the pdf plots
pond_par_area_plot_dat = pdp::partial(pond_rf, pred.var = c("log_area"), chull = TRUE)
pond_plot_log_area = ggplot(data = pond_par_area_plot_dat, aes(x = log_area, y = yhat))+
  theme_classic()+
  labs(x = "Log Surface Area (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_text(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_log_area

pond_par_abslat_plot_dat = pdp::partial(pond_rf, pred.var = c("abs_lat"), chull = TRUE)
pond_plot_abslat = ggplot(data = pond_par_abslat_plot_dat, aes(x = abs_lat, y = yhat))+
  theme_classic()+
  labs(x = "Latitude (\u00b0 from equator)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_abslat

pond_par_lognfert_plot_dat = pdp::partial(pond_rf, pred.var = c("log_n_fert"), chull = TRUE)
pond_plot_lognfert = ggplot(data = pond_par_lognfert_plot_dat, aes(x = 10^log_n_fert, y = yhat))+
  theme_classic()+
  labs(x = "N Fertilizer Use (kg N ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_lognfert

pond_par_logpfert_plot_dat = pdp::partial(pond_rf, pred.var = c("log_p_fert"), chull = TRUE)
pond_plot_logpfert = ggplot(data = pond_par_logpfert_plot_dat, aes(x = 10^log_p_fert, y = yhat))+
  theme_classic()+
  labs(x = "P Fertilizer Use (kg P ha<sup>-1</sup>)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_logpfert

pond_par_log_precip_plot_dat = pdp::partial(pond_rf, pred.var = c("log_precip"), chull = TRUE)
pond_plot_logprecip = ggplot(data = pond_par_log_precip_plot_dat, aes(x = 10^log_precip, y = yhat))+
  theme_classic()+
  labs(x = "Annual Precipitation (cm)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_logprecip

pond_par_elevation_plot_dat = pdp::partial(pond_rf, pred.var = c("elevation_km"), chull = TRUE)
pond_plot_elevation = ggplot(data = pond_par_elevation_plot_dat, aes(x = elevation_km, y = yhat))+
  theme_classic()+
  labs(x = "Elevation (km)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_elevation

pond_par_temp_plot_dat = pdp::partial(pond_rf, pred.var = c("mean_annual_temp_c"), chull = TRUE)
pond_plot_temp = ggplot(data = pond_par_temp_plot_dat, aes(x = mean_annual_temp_c, y = yhat))+
  theme_classic()+
  labs(x = "Mean Annual Temperature (\u00b0C)",
       y = expression(paste(hat(y))))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_text(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_line(size = 1.5, color = "black")
pond_plot_temp

pond_pdp_plot = pond_plot_log_area + pond_plot_abslat + pond_plot_lognfert + pond_plot_logpfert + pond_plot_logprecip + pond_plot_elevation + pond_plot_temp +
  plot_layout(nrow = 3, ncol = 3)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
pond_pdp_plot

ggsave(filename = "pond_pdp_plot.png", plot = pond_pdp_plot, width = 180, height = 180, units = "mm")
```


Make figures demonstrating predicted vs measured OC burial (using data withheld from model training compared to modelled rates for those same systems)
```{r}
#lakes first
#make the dataframe
lake_pred = predict(lake_rf, lake_test)
lake_rf_reg_table = cbind(lake_test, lake_pred$predictions)
lake_rf_reg_table$predictions = lake_rf_reg_table$`lake_pred$predictions`

summary(lm(predictions ~ log_burial, data = lake_rf_reg_table))

rf_reg_plot_lake = ggplot(data = lake_rf_reg_table, aes(x = log_burial, y = predictions))+
  theme_classic()+
  labs(x = "Log Measured C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)",
       y = "Log Predicted C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_continuous(limits = c (-1,3))+
  scale_y_continuous(limits = c (-1,3))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_point(shape = 16, size = 2, color = "blue")+
  geom_abline(slope = 1, intercept = 0, size = 1)+
  annotate("text", x = -1, y = 3, label = "Lakes", size = 2.822, hjust = 0)+
  annotate("text", x = -1, y = 2.733333333, label = expression(paste(italic("R"^2)," = 0.597")), size = 2.822, hjust = 0)+
  annotate("text", x = -1, y = 2.4666666666, label = "p < 0.001", size = 2.822, hjust = 0)
rf_reg_plot_lake

#repeat for impounmdents
reservoir_pred = predict(reservoir_rf, reservoir_test)
reservoir_rf_reg_table = cbind(reservoir_test, reservoir_pred$predictions)
reservoir_rf_reg_table$predictions = reservoir_rf_reg_table$`reservoir_pred$predictions`

summary(lm(predictions ~ log_burial, data = reservoir_rf_reg_table))

rf_reg_plot_reservoir = ggplot(data = reservoir_rf_reg_table, aes(x = log_burial, y = predictions))+
  theme_classic()+
  labs(x = "Log Measured C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)",
       y = "Log Predicted C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_continuous(limits = c (0,4))+
  scale_y_continuous(limits = c (0,4))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_point(shape = 16, size = 2, color = "blue")+
  geom_abline(slope = 1, intercept = 0, size = 1)+
  annotate("text", x = 0, y = 4, label = "Impoundments", size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 3.733333333, label = expression(paste(italic("R"^2)," = 0.516")), size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 3.4666666666, label = "p = 0.018", size = 2.822, hjust = 0)
rf_reg_plot_reservoir

#ponds
pond_pred = predict(pond_rf, pond_test)
pond_rf_reg_table = cbind(pond_test, pond_pred$predictions)
pond_rf_reg_table$predictions = pond_rf_reg_table$`pond_pred$predictions`

summary(lm(predictions ~ log_burial, data = pond_rf_reg_table))

rf_reg_plot_pond = ggplot(data = pond_rf_reg_table, aes(x = log_burial, y = predictions))+
  theme_classic()+
  labs(x = "Log Measured C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)",
       y = "Log Predicted C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_continuous(limits = c (0,4))+
  scale_y_continuous(limits = c (0,4))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_point(shape = 16, size = 2, color = "blue")+
  geom_abline(slope = 1, intercept = 0, size = 1)+
  annotate("text", x = 0, y = 4, label = "Ponds", size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 3.733333333, label = expression(paste(italic("R"^2)," = 0.719")), size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 3.4666666666, label = "p < 0.001", size = 2.822, hjust = 0)
rf_reg_plot_pond


#and wetlands
wetland_pred = predict(wetland_rf, wetland_test)
wetland_rf_reg_table = cbind(wetland_test, wetland_pred$predictions)
wetland_rf_reg_table$predictions = wetland_rf_reg_table$`wetland_pred$predictions`

summary(lm(predictions ~ log_burial, data = wetland_rf_reg_table))

rf_reg_plot_wetland = ggplot(data = wetland_rf_reg_table, aes(x = log_burial, y = predictions))+
  theme_classic()+
  labs(x = "Log Measured C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)",
       y = "Log Predicted C Burial<br>(g OC m<sup>-2</sup> yr<sup>-1</sup>)")+
  scale_x_continuous(limits = c (0,3))+
  scale_y_continuous(limits = c (0,3))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_markdown(size = 8, colour = "black"))+
  geom_point(shape = 16, size = 2, color = "blue")+
  geom_abline(slope = 1, intercept = 0, size = 1)+
  annotate("text", x = 0, y = 3, label = "Wetlands", size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 2.8, label = expression(paste(italic("R"^2)," = 0.514")), size = 2.822, hjust = 0)+
  annotate("text", x = 0, y = 2.6, label = "p < 0.001", size = 2.822, hjust = 0)
rf_reg_plot_wetland


rf_pred_meas_plot = rf_reg_plot_lake + rf_reg_plot_reservoir + rf_reg_plot_pond + rf_reg_plot_wetland +
  plot_layout(nrow = 2, ncol = 2)+
  plot_annotation(tag_levels = "A", tag_suffix = ".")& 
  theme(plot.tag = element_text(size = 8))
rf_pred_meas_plot

ggsave(filename = "rf_pred_meas_plot.png", plot = rf_pred_meas_plot, width = 180, height = 180, units = "mm")
```


Make a figure comparing the variable importance between/within systems
```{r}
library(readxl)
rf_varimportance <- read_excel("rforest_variable_importance.xlsx")
View(rf_varimportance)

lake_import = subset(rf_varimportance, System == "Lake")
imp_import = subset(rf_varimportance, System == "Impoundment")
pond_import = subset(rf_varimportance, System == "Pond")
wet_import = subset(rf_varimportance, System == "Wetland")

#make the plot for lakes:
lake_import_plot = ggplot(data = lake_import, aes(y = Variable, x = Importance))+
  geom_bar(stat = "identity", fill = "#1f78b4")+
  theme_classic()+
  scale_x_continuous(limits = c (0,35))+
  geom_vline(xintercept = 0, color = "black", size = 1)+
  scale_y_discrete(labels = c("Area",
                              "Elevation",
                              "Absolute Latitude",
                              "N Fertilizer",
                              "P Fertilizer",
                              "Precipitation",
                              "Temperature"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_markdown(size = 7,colour = "black"),
         axis.title.y = element_blank(),
         axis.title.x = element_markdown(size = 7, colour = "black"))+
  theme(legend.position="none")+
  labs(title = "Lakes")+
  theme(plot.title = element_text(size = 7, color = "black"))
lake_import_plot

#make the plot for impoundments:
imp_import_plot = ggplot(data = imp_import, aes(y = Variable, x = Importance))+
  geom_bar(stat = "identity", fill = "#a6cee3")+
  theme_classic()+
  scale_x_continuous(limits = c (0,6))+
  geom_vline(xintercept = 0, color = "black", size = 1)+
  scale_y_discrete(labels = c("Area",
                              "Elevation",
                              "Absolute Latitude",
                              "N Fertilizer",
                              "P Fertilizer",
                              "Precipitation",
                              "Temperature"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_markdown(size = 7,colour = "black"),
         axis.title.y = element_blank(),
         axis.title.x = element_markdown(size = 7, colour = "black"))+
  theme(legend.position="none")+
  labs(title = "Impoundments")+
  theme(plot.title = element_text(size = 7, color = "black"))
imp_import_plot

#make the plot for ponds:
pond_import_plot = ggplot(data = pond_import, aes(y = Variable, x = Importance))+
  geom_bar(stat = "identity", fill = "#b2df8a")+
  theme_classic()+
  scale_x_continuous(limits = c (0,25))+
  geom_vline(xintercept = 0, color = "black", size = 1)+
  scale_y_discrete(labels = c("Area",
                              "Elevation",
                              "Absolute Latitude",
                              "N Fertilizer",
                              "P Fertilizer",
                              "Precipitation",
                              "Temperature"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_markdown(size = 7,colour = "black"),
         axis.title.y = element_blank(),
         axis.title.x = element_markdown(size = 7, colour = "black"))+
  theme(legend.position="none")+
  labs(title = "Ponds")+
  theme(plot.title = element_text(size = 7, color = "black"))
pond_import_plot

#make the plot for wetlands:
wet_import_plot = ggplot(data = wet_import, aes(y = Variable, x = Importance))+
  geom_bar(stat = "identity", fill = "#33a02c")+
  theme_classic()+
  scale_x_continuous(limits = c (0,7))+
  geom_vline(xintercept = 0, color = "black", size = 1)+
  scale_y_discrete(labels = c("Area",
                              "Elevation",
                              "Absolute Latitude",
                              "N Fertilizer",
                              "P Fertilizer",
                              "Precipitation",
                              "Temperature"))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1))+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_markdown(size = 7,colour = "black"),
         axis.title.y = element_blank(),
         axis.title.x = element_markdown(size = 7, colour = "black"))+
  theme(legend.position="none")+
  labs(title = "Wetlands")+
  theme(plot.title = element_text(size = 7, color = "black"))+
  annotate("text", x = .5, y =1, label = "n.a.", size = 2.469, hjust = 0)
wet_import_plot

var_importance_plot = lake_import_plot + imp_import_plot + pond_import_plot + wet_import_plot +
  plot_layout(ncol = 4)+
  plot_annotation(tag_levels = "a")&
  theme(plot.tag = element_text(size = 7, face = "bold"))

var_importance_plot

var_importance_plot[[2]] = var_importance_plot[[2]] + theme(axis.text.y = element_blank(),
                                        axis.title.y = element_blank())
var_importance_plot[[3]] = var_importance_plot[[3]] + theme(axis.text.y = element_blank(),
                                        axis.title.y = element_blank())
var_importance_plot[[4]] = var_importance_plot[[4]] + theme(axis.text.y = element_blank(),
                                        axis.title.y = element_blank())
var_importance_plot

ggsave(filename = "forest_var_importance_plot.png", plot = var_importance_plot, width = 183, height =50, units = "mm")
```


Next, start making the global predictions
Load the global dataset for lakes and impounmdnets >= 0.1 km2:
```{r}
library(readxl)
HydroLAKES_polys_v10_a <- read_excel("HydroLAKES_polys_v10-a.xlsx")
View(HydroLAKES_polys_v10_a)

#and subset out just the constructed waterbodies (lake_type = 2)
hydro_reservoir = subset(HydroLAKES_polys_v10_a, Lake_type == "2")
hydro_reservoir$elevation_km = hydro_reservoir$Elevation/1000
```

Apply raster layers to the global reservoir dataset:
```{r}
require(sf)
#p fertilizer
pfertilizer = raster("pfertilizer_global.tif")
points = data.frame(lon = (hydro_reservoir$Pour_long), lat = (hydro_reservoir$Pour_lat))
points_sf = st_as_sf(points, coords = c("lon", "lat"), crs = "WGS84")
points_p = extract(pfertilizer, points_sf)
hydro_reservoir2 = cbind(hydro_reservoir, points_p)
hydro_reservoir2 = rename(hydro_reservoir2, p_fert_kg_ha = points_p)

#n_fertilizer
nfertilizer = raster("nfertilizer_global.tif")
points_n = extract(nfertilizer, points_sf)
hydro_reservoir3 = cbind(hydro_reservoir2, points_n)
hydro_reservoir3 = rename(hydro_reservoir3, n_fert_kg_ha = points_n)

#temperature
mean_annual_temp = raster("wc2.1_2.5m_bio_1.tif")
points_temp = extract(mean_annual_temp, points_sf)
hydro_reservoir4 = cbind(hydro_reservoir3, points_temp)
hydro_reservoir4 = rename(hydro_reservoir4, mean_annual_temp_c = points_temp)

#precipitation
annual_precip = raster("wc2.1_2.5m_bio_12.tif")
points_precip = extract(annual_precip, points_sf)
hydro_reservoir5 = cbind(hydro_reservoir4, points_precip)
hydro_reservoir5 = rename(hydro_reservoir5, annual_precip_mm = points_precip)
```


Predict OC burial for each impoundment >= 0.1 km2 using the trained random forest model
```{r}
#get the dataset tidied for prediction:
hydro_reservoir5$log_area = log10(hydro_reservoir5$Lake_area)
hydro_reservoir5$abs_lat = abs(hydro_reservoir5$Pour_lat)
hydro_reservoir5$log_n_fert = log10(hydro_reservoir5$n_fert_kg_ha + 0.00000000001)
hydro_reservoir5$log_p_fert = log10(hydro_reservoir5$p_fert_kg_ha + 0.00000000001)
hydro_reservoir5$log_precip = log10(hydro_reservoir5$annual_precip_mm/10)

res_pred_dat = hydro_reservoir5 %>% dplyr::select(log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#need to replace NAs... Make them 0 for now
res_pred_dat[is.na(res_pred_dat)] <- 0

#run the prediction:
global_res_c_bury = predict(reservoir_rf, res_pred_dat, type = "se", se.method = "infjack")
global_res_c_bury$predictions
global_res_c_bury$se

#try a rough estimate (sanity check!)
est_res_c_bury = cbind(global_res_c_bury, res_pred_dat)
est_res_c_bury$c_burial_g_m2_yr = 10^est_res_c_bury$prediction
est_res_c_bury$area_km2 = 10^est_res_c_bury$log_area
est_res_c_bury$burial = est_res_c_bury$c_burial_g_m2_yr *1000000 * est_res_c_bury$area_km2
sum(est_res_c_bury$burial)

#properly estimate global mean and total impoundment C burial
mean(est_res_c_bury$c_burial_g_m2_yr)
sd(est_res_c_bury$c_burial_g_m2_yr)
median(est_res_c_bury$c_burial_g_m2_yr)
quantile(est_res_c_bury$c_burial_g_m2_yr, probs = 0.25)
quantile(est_res_c_bury$c_burial_g_m2_yr, probs = 0.75)

#rnorm(mean = , sd = )
res_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(est_res_c_bury$prediction), mean = est_res_c_bury$prediction, sd = est_res_c_bury$se))*est_res_c_bury$area_km2*1000000), 
               length(est_res_c_bury$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_total_mean1 = as.vector(res_total_mean)
mean(res_total_mean1/(10^12))
sd(res_total_mean1/(10^12))
median(res_total_mean1/(10^12))
quantile(res_total_mean1, probs = 0.25)/(10^12)
quantile(res_total_mean1, probs = 0.75)/(10^12)


#export a csv of the predicted impoundment data
h_res_id = hydro_reservoir[1]
impound_export = cbind(h_res_id, est_res_c_bury)
impound_export = impound_export %>% dplyr::select(Hylak_id, c_burial_g_m2_yr, se, burial)

write.csv(impound_export, "global_impoundment_burial.csv")
```


Look into impoundment size class, biome, and latitude total and average burial
```{r}
#RE-ADD res NAME, POUR LAT, AREA, AND BIOME TO THE dataset (est_res_c_bury)
h_res_id_3 = hydro_reservoir[c(1,2,5,7,8)]
res_summaries = cbind(h_res_id_3, est_res_c_bury)

#lets look at tropics, temperate, polar
res_summaries$lat_categories = cut(abs(res_summaries$Pour_lat), breaks = c(0, 23.4361, 66.5, 90),
                                    labels = c("tropical", "temperate", "polar"))
res_lat_summary = res_summaries %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
res_lat_summary

#and then estimate total burial in each region
tropical_res = subset(res_summaries, lat_categories == "tropical")

tropical_res_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_res$prediction), mean = tropical_res$prediction, sd = tropical_res$se))*tropical_res$area_km2*1000000), 
               length(tropical_res$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_res_total_mean1 = as.vector(tropical_res_total_mean)
mean(tropical_res_total_mean1)/(10^12)
sd(tropical_res_total_mean1)/(10^12)
median(tropical_res_total_mean1)/(10^12)
quantile(tropical_res_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_res_total_mean1, probs = 0.75)/(10^12)


temperate_res = subset(res_summaries, lat_categories == "temperate")

temperate_res_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_res$prediction), mean = temperate_res$prediction, sd = temperate_res$se))*temperate_res$area_km2*1000000), 
               length(temperate_res$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_res_total_mean1 = as.vector(temperate_res_total_mean)
mean(temperate_res_total_mean1)/(10^12)
sd(temperate_res_total_mean1)/(10^12)
median(temperate_res_total_mean1)/(10^12)
quantile(temperate_res_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_res_total_mean1, probs = 0.75)/(10^12)


polar_res = subset(res_summaries, lat_categories == "polar")

polar_res_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_res$prediction), mean = polar_res$prediction, sd = polar_res$se))*polar_res$area_km2*1000000), 
               length(polar_res$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_res_total_mean1 = as.vector(polar_res_total_mean)
mean(polar_res_total_mean1)/(10^12)
sd(polar_res_total_mean1)/(10^12)
median(polar_res_total_mean1)/(10^12)
quantile(polar_res_total_mean1, probs = 0.25)/(10^12)
quantile(polar_res_total_mean1, probs = 0.75)/(10^12)


####look at burial by res size class
res_summaries$size_class = cut(abs(res_summaries$area_km2), breaks = c(0,1, 10, 100, 1000, 10000, 100000, 1000000),
                                    labels = c("<1km2", "1-10km2", "10-100km2", "100-1000km2","1000-10,000km2", "10,000-100,000km2", ">100,000km2"))

res_size_summary = res_summaries %>%
  group_by(size_class) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
res_size_summary

#less than 1km 2
res_less_1 = subset(res_summaries, size_class == "<1km2")
res_less_1_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(res_less_1$prediction), mean = res_less_1$prediction, sd = res_less_1$se))*res_less_1$area_km2*1000000), 
               length(res_less_1$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_less_mean1 = as.vector(res_less_1_total_mean)
mean(res_less_mean1)/(10^12)
sd(res_less_mean1)/(10^12)
median(res_less_mean1)/(10^12)
quantile(res_less_mean1, probs = 0.25)/(10^12)
quantile(res_less_mean1, probs = 0.75)/(10^12)

#1-10 1km 2
res_1_10 = subset(res_summaries, size_class == "1-10km2")
res_1_10_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(res_1_10$prediction), mean = res_1_10$prediction, sd = res_1_10$se))*res_1_10$area_km2*1000000), 
               length(res_1_10$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_1_10_total_mean1 = as.vector(res_1_10_total_mean)
mean(res_1_10_total_mean1)/(10^12)
sd(res_1_10_total_mean1)/(10^12)
median(res_1_10_total_mean1)
quantile(res_1_10_total_mean1, probs = 0.25)
quantile(res_1_10_total_mean1, probs = 0.75)

#10-100 1km 2
res_10_100 = subset(res_summaries, size_class == "10-100km2")
res_10_100_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(res_10_100$prediction), mean = res_10_100$prediction, sd = res_10_100$se))*res_10_100$area_km2*1000000), 
               length(res_10_100$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_10_100_total_mean1 = as.vector(res_10_100_total_mean)
mean(res_10_100_total_mean1)/(10^12)
sd(res_10_100_total_mean1)/(10^12)
median(res_10_100_total_mean1)
quantile(res_10_100_total_mean1, probs = 0.25)
quantile(res_10_100_total_mean1, probs = 0.75)  

#100-1000 1km 2
res_100_1000 = subset(res_summaries, size_class == "100-1000km2")
res_100_1000_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(res_100_1000$prediction), mean = res_100_1000$prediction, sd = res_100_1000$se))*res_100_1000$area_km2*1000000), 
               length(res_100_1000$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_100_1000_total_mean1 = as.vector(res_100_1000_total_mean)
mean(res_100_1000_total_mean1)/(10^12)
sd(res_100_1000_total_mean1)/(10^12)
median(res_100_1000_total_mean1)
quantile(res_100_1000_total_mean1, probs = 0.25)
quantile(res_100_1000_total_mean1, probs = 0.75)  


#1000-10000 1km 2
res_1000_10000 = subset(res_summaries, size_class == "1000-10,000km2")
res_1000_10000_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(res_1000_10000$prediction), mean = res_1000_10000$prediction, sd = res_1000_10000$se))*res_1000_10000$area_km2*1000000), 
               length(res_1000_10000$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

res_1000_10000_total_mean1 = as.vector(res_1000_10000_total_mean)
mean(res_1000_10000_total_mean1)/(10^12)
sd(res_1000_10000_total_mean1)/(10^12)
median(res_1000_10000_total_mean1)
quantile(res_1000_10000_total_mean1, probs = 0.25)
quantile(res_1000_10000_total_mean1, probs = 0.75)  

###make a graph of total C burial by res size class
size_class = c("<1km2", "1-10km2", "10-100km2", "100-1000km2","1000-10,000km2")
res_total_size_class = c(mean(temperate_res_total_mean1),
                         mean(res_1_10_total_mean1),
                         mean(res_10_100_total_mean1),
                         mean(res_100_1000_total_mean1),
                         mean(res_1000_10000_total_mean1))
res_error_size_class = c(sd(temperate_res_total_mean1),
                         sd(res_1_10_total_mean1),
                         sd(res_10_100_total_mean1),
                         sd(res_100_1000_total_mean1),
                         sd(res_1000_10000_total_mean1))
res_total_df = data.frame(size_class, res_total_size_class, res_error_size_class)
res_total_df


#and impoundment area by region
res_area_summary = res_summaries %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(area_km2),list(sum = sum))
res_area_summary
```

Export the data to make impoundment >=0.1km2 masp:
```{r}
#put the lat/long back
est_res_c_bury = cbind(est_res_c_bury, hydro_reservoir$Pour_lat)
est_res_c_bury = cbind(est_res_c_bury, hydro_reservoir$Pour_long)
est_res_c_bury = est_res_c_bury %>%
  rename("lat" = "hydro_reservoir$Pour_lat",
         "long" = "hydro_reservoir$Pour_long")

#plot it for a sanity check
res_av_map = ggplot(data = est_res_c_bury, aes(x = long, y = lat, fill = c_burial_g_m2_yr, color = c_burial_g_m2_yr))+
  geom_point()
res_av_map

#export a simple csv - lat, long, burial rate, and total burial
global_res_burial = est_res_c_bury %>%
  dplyr::select("lat", "long", "c_burial_g_m2_yr", "se", "burial")
write.csv(global_res_burial, "global_reservoir_burial.csv")
```


Make the global lake >=0.1km2 predictions:
```{r}
#get rid of the constructed waterbodies (lake_type = 2)
hydro_lake = subset(HydroLAKES_polys_v10_a, Lake_type != "2")
hydro_lake$elevation_km = hydro_lake$Elevation/1000

#add the layers
#p fertilizer
pfertilizer = raster("pfertilizer_global.tif")
points = data.frame(lon = (hydro_lake$Pour_long), lat = (hydro_lake$Pour_lat))
points_sf = st_as_sf(points, coords = c("lon", "lat"), crs = "WGS84")
points_p = extract(pfertilizer, points_sf)
hydro_lake2 = cbind(hydro_lake, points_p)
hydro_lake2 = rename(hydro_lake2, p_fert_kg_ha = points_p)

#n_fertilizer
nfertilizer = raster("nfertilizer_global.tif")
points_n = extract(nfertilizer, points_sf)
hydro_lake3 = cbind(hydro_lake2, points_n)
hydro_lake3 = rename(hydro_lake3, n_fert_kg_ha = points_n)

#temperature
mean_annual_temp = raster("wc2.1_2.5m_bio_1.tif")
points_temp = extract(mean_annual_temp, points_sf)
hydro_lake4 = cbind(hydro_lake3, points_temp)
hydro_lake4 = rename(hydro_lake4, mean_annual_temp_c = points_temp)

#precipitation
annual_precip = raster("wc2.1_2.5m_bio_12.tif")
points_precip = extract(annual_precip, points_sf)
hydro_lake5 = cbind(hydro_lake4, points_precip)
hydro_lake5 = rename(hydro_lake5, annual_precip_mm = points_precip)
```

Make the lake >=0.1km2 burial rate predictions:
```{r}
#get the dataset tidied for prediction:
hydro_lake5$log_area = log10(hydro_lake5$Lake_area)
hydro_lake5$abs_lat = abs(hydro_lake5$Pour_lat)
hydro_lake5$log_n_fert = log10(hydro_lake5$n_fert_kg_ha + 0.00000000001)
hydro_lake5$log_p_fert = log10(hydro_lake5$p_fert_kg_ha + 0.00000000001)
hydro_lake5$log_precip = log10(hydro_lake5$annual_precip_mm/10)

lake_pred_dat = hydro_lake5 %>% dplyr::select(log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#need to replace NAs... Make them 0 for now
lake_pred_dat[is.na(lake_pred_dat)] <- 0

#run the prediction:
#need to split the dataset up... Too big to run all at once (makes R sad :( on my office computer)
lake_pred_dat1 = lake_pred_dat[1:100000,]
global_lake_c_bury1 = predict(lake_rf, lake_pred_dat1, type = "se", se.method = "infjack")

lake_pred_dat2 = lake_pred_dat[100001:200000,]
global_lake_c_bury2 = predict(lake_rf, lake_pred_dat2, type = "se", se.method = "infjack")

lake_pred_dat3 = lake_pred_dat[200001:300000,]
global_lake_c_bury3 = predict(lake_rf, lake_pred_dat3, type = "se", se.method = "infjack")

lake_pred_dat4 = lake_pred_dat[300001:400000,]
global_lake_c_bury4 = predict(lake_rf, lake_pred_dat4, type = "se", se.method = "infjack")

lake_pred_dat5 = lake_pred_dat[400001:500000,]
global_lake_c_bury5 = predict(lake_rf, lake_pred_dat5, type = "se", se.method = "infjack")

lake_pred_dat6 = lake_pred_dat[500001:600000,]
global_lake_c_bury6 = predict(lake_rf, lake_pred_dat6, type = "se", se.method = "infjack")

lake_pred_dat7 = lake_pred_dat[600001:700000,]
global_lake_c_bury7 = predict(lake_rf, lake_pred_dat7, type = "se", se.method = "infjack")

lake_pred_dat8 = lake_pred_dat[700001:800000,]
global_lake_c_bury8 = predict(lake_rf, lake_pred_dat8, type = "se", se.method = "infjack")

lake_pred_dat9 = lake_pred_dat[800001:900000,]
global_lake_c_bury9 = predict(lake_rf, lake_pred_dat9, type = "se", se.method = "infjack")

lake_pred_dat10 = lake_pred_dat[900001:1000000,]
global_lake_c_bury10 = predict(lake_rf, lake_pred_dat10, type = "se", se.method = "infjack")

lake_pred_dat11 = lake_pred_dat[1000001:1043146,]
global_lake_c_bury11 = predict(lake_rf, lake_pred_dat11, type = "se", se.method = "infjack")

#and then put it back together
est_lake_c_bury1 = cbind(global_lake_c_bury1, lake_pred_dat1)
est_lake_c_bury1 = est_lake_c_bury1[-c(4:9)]
est_lake_c_bury2 = cbind(global_lake_c_bury2, lake_pred_dat2)
est_lake_c_bury2 = est_lake_c_bury2[-c(4:9)]
est_lake_c_bury3 = cbind(global_lake_c_bury3, lake_pred_dat3)
est_lake_c_bury3 = est_lake_c_bury3[-c(4:9)]
est_lake_c_bury4 = cbind(global_lake_c_bury4, lake_pred_dat4)
est_lake_c_bury4 = est_lake_c_bury4[-c(4:9)]
est_lake_c_bury5 = cbind(global_lake_c_bury5, lake_pred_dat5)
est_lake_c_bury5 = est_lake_c_bury5[-c(4:9)]
est_lake_c_bury6 = cbind(global_lake_c_bury6, lake_pred_dat6)
est_lake_c_bury6 = est_lake_c_bury6[-c(4:9)]
est_lake_c_bury7 = cbind(global_lake_c_bury7, lake_pred_dat7)
est_lake_c_bury7 = est_lake_c_bury7[-c(4:9)]
est_lake_c_bury8 = cbind(global_lake_c_bury8, lake_pred_dat8)
est_lake_c_bury8 = est_lake_c_bury8[-c(4:9)]
est_lake_c_bury9 = cbind(global_lake_c_bury9, lake_pred_dat9)
est_lake_c_bury9 = est_lake_c_bury9[-c(4:9)]
est_lake_c_bury10 = cbind(global_lake_c_bury10, lake_pred_dat10)
est_lake_c_bury10 = est_lake_c_bury10[-c(4:9)]
est_lake_c_bury11 = cbind(global_lake_c_bury11, lake_pred_dat11)
est_lake_c_bury11 = est_lake_c_bury11[-c(4:9)]

est_lake_c_bury = rbind(est_lake_c_bury1, est_lake_c_bury2, est_lake_c_bury3, est_lake_c_bury4, est_lake_c_bury5,
                        est_lake_c_bury6, est_lake_c_bury7, est_lake_c_bury8, est_lake_c_bury9, est_lake_c_bury10, est_lake_c_bury11)

#try a rough estimate (sanity check!)
est_lake_c_bury$c_burial_g_m2_yr = 10^est_lake_c_bury$prediction
est_lake_c_bury$area_km2 = 10^est_lake_c_bury$log_area
est_lake_c_bury$burial = est_lake_c_bury$c_burial_g_m2_yr *1000000 * est_lake_c_bury$area_km2
sum(est_lake_c_bury$burial)

#estimate total lake burial gloablly with error - will need to re-estimate total burial for each waterbody by drawing a new average rate given modeled rate and error
#get average/median info on rates
mean(est_lake_c_bury$c_burial_g_m2_yr)
sd(est_lake_c_bury$c_burial_g_m2_yr)
median(est_lake_c_bury$c_burial_g_m2_yr)
quantile(est_lake_c_bury$c_burial_g_m2_yr, probs = 0.25)
quantile(est_lake_c_bury$c_burial_g_m2_yr, probs = 0.75)


#rnorm(mean = , sd = )
lake_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = 1043146, mean = est_lake_c_bury$prediction, sd = est_lake_c_bury$se))*est_lake_c_bury$area_km2*1000000), 
               length(est_lake_c_bury$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_total_mean1 = as.vector(lake_total_mean)
mean(lake_total_mean1)/(10^12)
sd(lake_total_mean1)/(10^12)
median(lake_total_mean1)/(10^12)
quantile(lake_total_mean1, probs = 0.25)/(10^12)
quantile(lake_total_mean1, probs = 0.75)/(10^12)

#export a csv of the predicted lake >=0.1km2 data
h_lake_id_2 = hydro_lake[1]
lake_export = cbind(h_lake_id_2, est_lake_c_bury)
lake_export = lake_export %>% dplyr::select(Hylak_id, c_burial_g_m2_yr, se, burial)

write.csv(lake_export, "global_lake_burial.csv")

```

Look into lake size class, biome, and latitude total and average burial
```{r}
#RE-ADD LAKE NAME, POUR LAT, AREA, AND BIOME TO THE LAKES (est_lake_c_bury)
h_lake_id_3 = hydro_lake[c(1,2,5,7,8)]
lake_summaries = cbind(h_lake_id_3, est_lake_c_bury)

#lets look at tropics, temperate, polar
lake_summaries$lat_categories = cut(abs(lake_summaries$Pour_lat), breaks = c(0, 23.4361, 66.5, 90),
                                    labels = c("tropical", "temperate", "polar"))
lake_lat_summary = lake_summaries %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
lake_lat_summary

#and then estimate total burial in each region
tropical_lake = subset(lake_summaries, lat_categories == "tropical")

tropical_lake_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_lake$prediction), mean = tropical_lake$prediction, sd = tropical_lake$se))*tropical_lake$area_km2*1000000), 
               length(tropical_lake$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_lake_total_mean1 = as.vector(tropical_lake_total_mean)
mean(tropical_lake_total_mean1)/(10^12)
sd(tropical_lake_total_mean1)/(10^12)
median(tropical_lake_total_mean1)/(10^12)
quantile(tropical_lake_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_lake_total_mean1, probs = 0.75)/(10^12)


temperate_lake = subset(lake_summaries, lat_categories == "temperate")

temperate_lake_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_lake$prediction), mean = temperate_lake$prediction, sd = temperate_lake$se))*temperate_lake$area_km2*1000000), 
               length(temperate_lake$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_lake_total_mean1 = as.vector(temperate_lake_total_mean)
mean(temperate_lake_total_mean1)/(10^12)
sd(temperate_lake_total_mean1)/(10^12)
median(temperate_lake_total_mean1)/(10^12)
quantile(temperate_lake_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_lake_total_mean1, probs = 0.75)/(10^12)


polar_lake = subset(lake_summaries, lat_categories == "polar")

polar_lake_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_lake$prediction), mean = polar_lake$prediction, sd = polar_lake$se))*polar_lake$area_km2*1000000), 
               length(polar_lake$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_lake_total_mean1 = as.vector(polar_lake_total_mean)
mean(polar_lake_total_mean1)/(10^12)
sd(polar_lake_total_mean1)/(10^12)
median(polar_lake_total_mean1)/(10^12)
quantile(polar_lake_total_mean1, probs = 0.25)/(10^12)
quantile(polar_lake_total_mean1, probs = 0.75)/(10^12)


####look at burial by lake size class
lake_summaries$size_class = cut(abs(lake_summaries$area_km2), breaks = c(0,1, 10, 100, 1000, 10000, 100000, 1000000),
                                    labels = c("<1km2", "1-10km2", "10-100km2", "100-1000km2","1000-10,000km2", "10,000-100,000km2", ">100,000km2"))

lake_size_summary = lake_summaries %>%
  group_by(size_class) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
lake_size_summary

#less than 1km 2
lake_less_1 = subset(lake_summaries, size_class == "<1km2")
lake_less_1_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_less_1$prediction), mean = lake_less_1$prediction, sd = lake_less_1$se))*lake_less_1$area_km2*1000000), 
               length(lake_less_1$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_lake_total_mean1 = as.vector(lake_less_1_total_mean)
mean(temperate_lake_total_mean1)/(10^12)
sd(temperate_lake_total_mean1)/(10^12)
median(temperate_lake_total_mean1)
quantile(temperate_lake_total_mean1, probs = 0.25)
quantile(temperate_lake_total_mean1, probs = 0.75)

#1-10 1km 2
lake_1_10 = subset(lake_summaries, size_class == "1-10km2")
lake_1_10_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_1_10$prediction), mean = lake_1_10$prediction, sd = lake_1_10$se))*lake_1_10$area_km2*1000000), 
               length(lake_1_10$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_1_10_total_mean1 = as.vector(lake_1_10_total_mean)
mean(lake_1_10_total_mean1)/(10^12)
sd(lake_1_10_total_mean1)/(10^12)
median(lake_1_10_total_mean1)
quantile(lake_1_10_total_mean1, probs = 0.25)
quantile(lake_1_10_total_mean1, probs = 0.75)

#10-100 1km 2
lake_10_100 = subset(lake_summaries, size_class == "10-100km2")
lake_10_100_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_10_100$prediction), mean = lake_10_100$prediction, sd = lake_10_100$se))*lake_10_100$area_km2*1000000), 
               length(lake_10_100$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_10_100_total_mean1 = as.vector(lake_10_100_total_mean)
mean(lake_10_100_total_mean1)/(10^12)
sd(lake_10_100_total_mean1)/(10^12)
median(lake_10_100_total_mean1)
quantile(lake_10_100_total_mean1, probs = 0.25)
quantile(lake_10_100_total_mean1, probs = 0.75)  

#100-1000 1km 2
lake_100_1000 = subset(lake_summaries, size_class == "100-1000km2")
lake_100_1000_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_100_1000$prediction), mean = lake_100_1000$prediction, sd = lake_100_1000$se))*lake_100_1000$area_km2*1000000), 
               length(lake_100_1000$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_100_1000_total_mean1 = as.vector(lake_100_1000_total_mean)
mean(lake_100_1000_total_mean1)/(10^12)
sd(lake_100_1000_total_mean1)/(10^12)
median(lake_100_1000_total_mean1)
quantile(lake_100_1000_total_mean1, probs = 0.25)
quantile(lake_100_1000_total_mean1, probs = 0.75)  


#1000-10000 1km 2
lake_1000_10000 = subset(lake_summaries, size_class == "1000-10,000km2")
lake_1000_10000_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_1000_10000$prediction), mean = lake_1000_10000$prediction, sd = lake_1000_10000$se))*lake_1000_10000$area_km2*1000000), 
               length(lake_1000_10000$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_1000_10000_total_mean1 = as.vector(lake_1000_10000_total_mean)
mean(lake_1000_10000_total_mean1)/(10^12)
sd(lake_1000_10000_total_mean1)/(10^12)
median(lake_1000_10000_total_mean1)
quantile(lake_1000_10000_total_mean1, probs = 0.25)
quantile(lake_1000_10000_total_mean1, probs = 0.75)  

#1000-10000 1km 2
lake_10000_100000 = subset(lake_summaries, size_class == "10,000-100,000km2")
lake_10000_100000_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(lake_10000_100000$prediction), mean = lake_10000_100000$prediction, sd = lake_10000_100000$se))*lake_10000_100000$area_km2*1000000), 
               length(lake_10000_100000$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

lake_10000_100000_total_mean1 = as.vector(lake_10000_100000_total_mean)
mean(lake_10000_100000_total_mean1)/(10^12)
sd(lake_10000_100000_total_mean1)/(10^12)
median(lake_10000_100000_total_mean1)
quantile(lake_10000_100000_total_mean1, probs = 0.25)
quantile(lake_10000_100000_total_mean1, probs = 0.75)

#and the Caspian Sea
caspian = subset(lake_summaries, Lake_name == "Caspian Sea")
caspian$burial/(10^12)

#sum lake area by latitude
lake_area_summary = lake_summaries %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(area_km2),list(sum = sum))
lake_area_summary
```



And export the lake data to make rasters:
```{r}
#put the lat/long back
est_lake_c_bury = cbind(est_lake_c_bury, hydro_lake$Pour_lat)
est_lake_c_bury = cbind(est_lake_c_bury, hydro_lake$Pour_long)
est_lake_c_bury = est_lake_c_bury %>%
  rename("lat" = "hydro_lake$Pour_lat",
         "long" = "hydro_lake$Pour_long")

lake_av_map = ggplot(data = est_lake_c_bury, aes(x = long, y = lat, fill = c_burial_g_m2_yr, color = c_burial_g_m2_yr))+
  geom_point()
lake_av_map
#generally makes sense...

#export as a csv...
global_lake_burial = est_lake_c_bury %>%
  dplyr::select("lat", "long", "c_burial_g_m2_yr", "se", "burial")
write.csv(global_lake_burial, "global_lake_burial.csv")
```



And now the wetland scaling
```{r}
#load the tif file of approximate wetland area per grid cell
#made from GLDW - excludes lacustrine wetlands and any salty wetlands
GLWD_V2_wetlands_km2_1d_res <- read_csv("GLWD_V2_wetlands_km2_1d_res.csv")

#pfertilizer
pfertilizer = raster("pfertilizer_global.tif")
plot(pfertilizer)
points = data.frame(lon = (GLWD_V2_wetlands_km2_1d_res$long), lat = (GLWD_V2_wetlands_km2_1d_res$lat))
points_sf = st_as_sf(points, coords = c("lon", "lat"), crs = "WGS84")
points_p = extract(pfertilizer, points_sf)
glwd2 = cbind(GLWD_V2_wetlands_km2_1d_res, points_p)
glwd2 = rename(glwd2, p_fert_kg_ha = points_p)

#n_fertilizer
nfertilizer = raster("nfertilizer_global.tif")
points_n = extract(nfertilizer, points_sf)
glwd3 = cbind(glwd2, points_n)
glwd3 = rename(glwd3, n_fert_kg_ha = points_n)

#temperature
mean_annual_temp = raster("wc2.1_2.5m_bio_1.tif")
points_temp = extract(mean_annual_temp, points_sf)
glwd4 = cbind(glwd3, points_temp)
glwd4 = rename(glwd4, mean_annual_temp_c = points_temp)

#precipitation
annual_precip = raster("wc2.1_2.5m_bio_12.tif")
points_precip = extract(annual_precip, points_sf)
glwd5 = cbind(glwd4, points_precip)
glwd5 = rename(glwd5, annual_precip_mm = points_precip)

#load an elevation map
#  from https://asterweb.jpl.nasa.gov/gdem.asp
elevation = raster("GDEM-10km-colorized.tif")
elevation
plot(elevation)
points_elev = extract(elevation, points_sf)
glwd6 = cbind(glwd5, points_elev)
glwd6 = rename(glwd6, points_elev = points_elev)
```


```{r}
#get the dataset tidied for prediction:
glwd6$abs_lat = abs(glwd6$lat)
glwd6$log_n_fert = log10(glwd6$n_fert_kg_ha + 0.00000000001)
glwd6$log_p_fert = log10(glwd6$p_fert_kg_ha + 0.00000000001)
glwd6$log_precip = log10(glwd6$annual_precip_mm/10)
glwd6$elevation_km = glwd6$points_elev/100
max(glwd6$elevation_km)
mean(glwd6$elevation_km)

wetland_pred_dat = glwd6 %>% dplyr::select(abs_lat, log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)

#need to replace NAs... Make them 0 for now
wetland_pred_dat[is.na(wetland_pred_dat)] <- 0

global_wetland_c_bury = predict(wetland_rf, wetland_pred_dat, type = "se", se.method = "infjack")
global_wetland_c_bury$predictions
global_wetland_c_bury$se

#try a rough estimate (sanity check!)
est_wetland_c_bury = cbind(global_wetland_c_bury, wetland_pred_dat, glwd6$wetland_km)
est_wetland_c_bury$c_burial_g_m2_yr = 10^est_wetland_c_bury$prediction
est_wetland_c_bury$burial = est_wetland_c_bury$c_burial_g_m2_yr *1000000 * est_wetland_c_bury$`glwd6$wetland_km`

sum(est_wetland_c_bury$burial)

#get the burial rate averages
mean(est_wetland_c_bury$c_burial_g_m2_yr)
sd(est_wetland_c_bury$c_burial_g_m2_yr)
median(est_wetland_c_bury$c_burial_g_m2_yr)
quantile(est_wetland_c_bury$c_burial_g_m2_yr, probs = 0.25)
quantile(est_wetland_c_bury$c_burial_g_m2_yr, probs = 0.75)

#rnorm(mean = , sd = )
wetland_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(est_wetland_c_bury$prediction), mean = est_wetland_c_bury$prediction, sd = est_wetland_c_bury$se))*est_wetland_c_bury$`glwd6$wetland_km`*1000000), 
               length(est_wetland_c_bury$prediction), replace = T)
  sum(x_i)
})

wetland_total_mean1 = as.vector(wetland_total_mean)
mean(wetland_total_mean1)/(10^12)
sd(wetland_total_mean1)/(10^12)
median(wetland_total_mean1)/(10^12)
quantile(wetland_total_mean1, probs = 0.25)/(10^12)
quantile(wetland_total_mean1, probs = 0.75)/(10^12)
```


```{r}
#lets look at tropics, temperate, polar
est_wetland_c_bury$lat_categories = cut(abs(est_wetland_c_bury$abs_lat), breaks = c(0, 23.4361, 66.5, 90),
                                    labels = c("tropical", "temperate", "polar"))
wetland_c_bury_lat = est_wetland_c_bury %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(median = median,
                           Q1=~quantile(., probs = 0.25),
                           Q3=~quantile(., probs = 0.75),
                           mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
wetland_c_bury_lat

#and then estimate total burial in each region
tropical_wet = subset(est_wetland_c_bury, lat_categories == "tropical")

tropical_wet_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_wet$prediction), mean = tropical_wet$prediction, sd = tropical_wet$se))*tropical_wet$`glwd6$wetland_km`*1000000), 
               length(tropical_wet$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_wet_total_mean1 = as.vector(tropical_wet_total_mean)
mean(tropical_wet_total_mean1)/(10^12)
sd(tropical_wet_total_mean1)/(10^12)
median(tropical_wet_total_mean1)/(10^12)
quantile(tropical_wet_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_wet_total_mean1, probs = 0.75)/(10^12)


temperate_wet = subset(est_wetland_c_bury, lat_categories == "temperate")

temperate_wet_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_wet$prediction), mean = temperate_wet$prediction, sd = temperate_wet$se))*temperate_wet$`glwd6$wetland_km`*1000000), 
               length(temperate_wet$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_wet_total_mean1 = as.vector(temperate_wet_total_mean)
mean(temperate_wet_total_mean1)/(10^12)
sd(temperate_wet_total_mean1)/(10^12)
median(temperate_wet_total_mean1)/(10^12)
quantile(temperate_wet_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_wet_total_mean1, probs = 0.75)/(10^12)


polar_wet = subset(est_wetland_c_bury, lat_categories == "polar")

polar_wet_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_wet$prediction), mean = polar_wet$prediction, sd = polar_wet$se))*polar_wet$`glwd6$wetland_km`*1000000), 
               length(polar_wet$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_wet_total_mean1 = as.vector(polar_wet_total_mean)
mean(polar_wet_total_mean1)/(10^12)
sd(polar_wet_total_mean1)/(10^12)
median(polar_wet_total_mean1)/(10^12)
quantile(polar_wet_total_mean1, probs = 0.25)/(10^12)
quantile(polar_wet_total_mean1, probs = 0.75)/(10^12)


#area by latitude
wet_area_summary = est_wetland_c_bury %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(`glwd6$wetland_km`),list(sum = sum))
wet_area_summary
```

And make the data file for generating a wetland raster layer:
```{r}
#put the lat/long back
est_wet_c_bury = cbind(est_wetland_c_bury, GLWD_V2_wetlands_km2_1d_res$lat)
est_wet_c_bury = cbind(est_wet_c_bury, GLWD_V2_wetlands_km2_1d_res$long)
est_wet_c_bury = est_wet_c_bury %>%
  rename("lat" = "GLWD_V2_wetlands_km2_1d_res$lat",
         "long" = "GLWD_V2_wetlands_km2_1d_res$long")

wetland_av_map = ggplot(data = est_wet_c_bury, aes(x = long, y = lat, fill = c_burial_g_m2_yr, color = c_burial_g_m2_yr))+
  geom_point()
wetland_av_map
#generally makes sense...

#export as a csv
global_wetland_burial = est_wet_c_bury %>%
  dplyr::select("lat", "long", "c_burial_g_m2_yr", "se", "burial")
write.csv(global_wetland_burial, "global_wetland_burial.csv")
```



Now, move on to the ponds and lakes < 0.1km2 predictions
First, need to calculate biome specific surface area equations by size class
```{r}
#load the dataset
lake_area_per_cell = read_csv("updated_cell_data - pond scaling.csv")

lake_area_per_cell$BIOME_NUM = as.factor(lake_area_per_cell$BIOME_NUM)
lake_area_per_cell$prop_area_0.1 = (lake_area_per_cell$SUM_Lake_area_0.1 / lake_area_per_cell$Sq_area)
lake_area_per_cell$prop_area_1 = (lake_area_per_cell$SUM_Lake_area_1 / lake_area_per_cell$Sq_area)
lake_area_per_cell$prop_area_10 = (lake_area_per_cell$SUM_Lake_area_10 / lake_area_per_cell$Sq_area)
lake_area_per_cell$prop_area_100 = (lake_area_per_cell$SUM_Lake_area_100 / lake_area_per_cell$Sq_area)
lake_area_per_cell$prop_area_1000 = (lake_area_per_cell$SUM_Lake_area_1000 / lake_area_per_cell$Sq_area)
lake_area_per_cell$prop_area_10000 = (lake_area_per_cell$SUM_Lake_area_10000 / lake_area_per_cell$Sq_area)

biome_size_dat = lake_area_per_cell %>%
  group_by(BIOME_NUM) %>%
  dplyr::summarize(area_0.1 = mean(prop_area_0.1),
                   area_1 = mean(prop_area_1),
                   area_10 = mean(prop_area_10),
                   area_100 = mean(prop_area_100),
                   area_1000 = mean(prop_area_1000),
                   area_10000 = mean(prop_area_10000))
biome_size_dat = melt(biome_size_dat, id.vars = c("BIOME_NUM"))

biome_size_dat = rename(biome_size_dat, proportional_area = value)

biome_size_dat2 = biome_size_dat %>%
  add_column(size_class =
              case_when(.$variable == "area_0.1" ~ 0.1,
                        .$variable == "area_1" ~ 1,
                        .$variable == "area_10" ~ 10,
                        .$variable == "area_100" ~ 100,
                        .$variable == "area_1000" ~ 1000,
                        .$variable == "area_10000" ~ 10000),
             .after = "proportional_area")

#and we need to change proportional area to something else since we should not log transform proportions...
#can try percent (x100) or x1000 and then convert from proportion to odds
biome_size_dat2$odds = (biome_size_dat2$proportional_area)/(1 - biome_size_dat2$proportional_area)

biome_size_dat3 = subset(biome_size_dat2, variable != "area_10000")

#do the regressions
biome1_size_dat = subset(biome_size_dat3, BIOME_NUM == "1")
biome1_size_mod = lm(data = biome1_size_dat, log10(odds) ~ log10(size_class))
summary(biome1_size_mod)

biome2_size_dat = subset(biome_size_dat3, BIOME_NUM == "2")
biome2_size_mod = lm(data = biome2_size_dat, log10(odds) ~ log10(size_class))
summary(biome2_size_mod)

biome3_size_dat = subset(biome_size_dat3, BIOME_NUM == "3")
biome3_size_dat = biome3_size_dat[apply(biome3_size_dat!=0, 1, all),]
biome3_size_mod = lm(data = biome3_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome3_size_dat, log10(odds) ~ log10(size_class))
summary(biome3_size_mod)

biome4_size_dat = subset(biome_size_dat3, BIOME_NUM == "4")
biome4_size_mod = lm(data = biome4_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome4_size_dat, log10(odds) ~ log10(size_class))
summary(biome4_size_mod)

biome5_size_dat = subset(biome_size_dat3, BIOME_NUM == "5")
biome5_size_mod = lm(data = biome5_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome5_size_dat, log10(odds) ~ log10(size_class))
summary(biome5_size_mod)

biome6_size_dat = subset(biome_size_dat3, BIOME_NUM == "6")
biome6_size_mod = lm(data = biome6_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome6_size_dat, log10(odds) ~ log10(size_class))
summary(biome6_size_mod)

biome7_size_dat = subset(biome_size_dat3, BIOME_NUM == "7")
biome7_size_mod = lm(data = biome7_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome7_size_dat, log10(odds) ~ log10(size_class))
summary(biome7_size_mod)

biome8_size_dat = subset(biome_size_dat3, BIOME_NUM == "8")
biome8_size_mod = lm(data = biome8_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome8_size_dat, log10(odds) ~ log10(size_class))
summary(biome8_size_mod)

biome9_size_dat = subset(biome_size_dat3, BIOME_NUM == "9")
biome9_size_mod = lm(data = biome9_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome9_size_dat, log10(odds) ~ log10(size_class))
summary(biome9_size_mod)

biome10_size_dat = subset(biome_size_dat3, BIOME_NUM == "10")
biome10_size_mod = lm(data = biome10_size_dat, log10(odds) ~ log10(size_class))
plot(data = biome10_size_dat, log10(odds) ~ log10(size_class))
summary(biome10_size_mod)

biome11_size_dat = subset(biome_size_dat3, BIOME_NUM == "11")
biome11_size_mod = lm(data = biome11_size_dat, log10(odds) ~ log10(size_class))
summary(biome11_size_mod)

biome12_size_dat = subset(biome_size_dat3, BIOME_NUM == "12")
biome12_size_dat = biome12_size_dat[apply(biome12_size_dat!=0, 1, all),]
biome12_size_mod = lm(data = biome12_size_dat, log10(odds) ~ log10(size_class))
summary(biome12_size_mod)

biome13_size_dat = subset(biome_size_dat3, BIOME_NUM == "13")
biome13_size_mod = lm(data = biome13_size_dat, log10(odds) ~ log10(size_class))
summary(biome13_size_mod)


#make a figure
biome_size_dist_plot = ggplot()+
  theme_classic()+
  geom_smooth(data = biome1_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#809B82", fill = "#809B82")+
  geom_smooth(data = biome2_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#84bb8e", fill = "#84bb8e")+
  geom_smooth(data = biome3_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#81d4a5", fill = "#81d4a5")+
  geom_smooth(data = biome4_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#c8e4a3", fill = "#c8e4a3")+
  geom_smooth(data = biome5_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#97b5bc", fill = "#97b5bc")+
  geom_smooth(data = biome6_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#b1cbe5", fill = "#b1cbe5")+
  geom_smooth(data = biome7_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#b6a47f", fill = "#b6a47f")+
  geom_smooth(data = biome8_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#d1c383", fill = "#d1c383")+
  geom_smooth(data = biome9_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#e5e184", fill = "#e5e184")+
  geom_smooth(data = biome10_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#F6F780", fill = "#F6F780")+
  geom_smooth(data = biome11_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#DCE7F5", fill = "#DCE7F5")+
  geom_smooth(data = biome12_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#E4B692", fill = "#E4B692")+
  geom_smooth(data = biome13_size_dat, aes(x = log10(size_class), y = proportional_area), method = "lm", color = "#F6CCA2", fill = "#F6CCA2")+
  #scale_y_continuous(limits = c(0,500))+
  labs(y = "Proportion of Grid Cell Area")+
  theme(axis.text.x =  element_text(size = 8,colour = "black"),
         axis.text.y =  element_text(size = 8,colour = "black"),
         axis.title.y = element_markdown(size = 8, colour = "black"),
         axis.title.x = element_text(size = 8,colour = "black"))+
  theme(legend.position = "None")

biome_size_dist_plot
```



Apply these distributions to each grid cell
```{r}
#try for biome 1 first
biome1_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "1")
biome1_area_per_cell$biome_slope = -0.13875
biome1_area_per_cell$biome_intercept = -2.26595
biome1_area_per_cell$odds_0.1 = (biome1_area_per_cell$prop_area_0.1) / (1 - biome1_area_per_cell$prop_area_0.1)

#caluclate biome 0.1 intercept and 0.1 intercept for each cell
biome1_area_per_cell$biome_point1_log = (-0.13875*log10(0.1) - 2.26595)
biome1_area_per_cell$cell_point1_log = log10(biome1_area_per_cell$odds_0.1)
biome1_area_per_cell$delta_point1 = abs(biome1_area_per_cell$biome_point1_log - biome1_area_per_cell$cell_point1_log)

biome1_area_per_cell$cell_intercept = ifelse(biome1_area_per_cell$biome_point1_log > biome1_area_per_cell$cell_point1_log,
                                             biome1_area_per_cell$biome_intercept - biome1_area_per_cell$delta_point1,
                                             biome1_area_per_cell$biome_intercept + biome1_area_per_cell$delta_point1)
min(biome1_area_per_cell$cell_intercept)
max(biome1_area_per_cell$cell_intercept)

#now use this new relationship to estimate actual area for 0.01, 0.001, and 0.0001 size class ponds
#will need to estimate cumulative proportional area and multiply that by the cell area to get cumulative area
biome1_area_per_cell$odds_area_0.01 = 10^(-0.13875*log10(0.01) + biome1_area_per_cell$cell_intercept)
biome1_area_per_cell$SUM_Lake_area_0.01 = (biome1_area_per_cell$odds_area_0.01/(biome1_area_per_cell$odds_area_0.01 + 1))*biome1_area_per_cell$Sq_area

biome1_area_per_cell$odds_area_0.001 = 10^(-0.13875*log10(0.001) + biome1_area_per_cell$cell_intercept)
biome1_area_per_cell$SUM_Lake_area_0.001 = (biome1_area_per_cell$odds_area_0.001/(biome1_area_per_cell$odds_area_0.001 + 1))*biome1_area_per_cell$Sq_area

biome1_area_per_cell$odds_area_0.0001 = 10^(-0.13875*log10(0.0001) + biome1_area_per_cell$cell_intercept)
biome1_area_per_cell$SUM_Lake_area_0.0001 = (biome1_area_per_cell$odds_area_0.0001/(biome1_area_per_cell$odds_area_0.0001 + 1))*biome1_area_per_cell$Sq_area

#and then subtract these out to get actual area by size class!
biome1_area_per_cell$pond_area_0.01 = biome1_area_per_cell$SUM_Lake_area_0.01 - biome1_area_per_cell$SUM_Lake_area_0.1
min(biome1_area_per_cell$pond_area_0.01)
max(biome1_area_per_cell$pond_area_0.01)

biome1_area_per_cell$pond_area_0.001 = biome1_area_per_cell$SUM_Lake_area_0.001 - biome1_area_per_cell$SUM_Lake_area_0.01
min(biome1_area_per_cell$pond_area_0.001)
max(biome1_area_per_cell$pond_area_0.001)

biome1_area_per_cell$pond_area_0.0001 = biome1_area_per_cell$SUM_Lake_area_0.0001 - biome1_area_per_cell$SUM_Lake_area_0.001
min(biome1_area_per_cell$pond_area_0.0001)
max(biome1_area_per_cell$pond_area_0.0001)

#repeat for the other biomes
#biome2
biome2_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "2")
biome2_area_per_cell$biome_slope = -0.14906
biome2_area_per_cell$biome_intercept = -2.26595
biome2_area_per_cell$odds_0.1 = (biome2_area_per_cell$prop_area_0.1) / (1 - biome2_area_per_cell$prop_area_0.1)
biome2_area_per_cell$biome_point1_log = (biome2_area_per_cell$biome_slope*log10(0.1) + biome2_area_per_cell$biome_intercept)
biome2_area_per_cell$cell_point1_log = log10(biome2_area_per_cell$odds_0.1)
biome2_area_per_cell$delta_point1 = abs(biome2_area_per_cell$biome_point1_log - biome2_area_per_cell$cell_point1_log)
biome2_area_per_cell$cell_intercept = ifelse(biome2_area_per_cell$biome_point1_log > biome2_area_per_cell$cell_point1_log,
                                             biome2_area_per_cell$biome_intercept - biome2_area_per_cell$delta_point1,
                                             biome2_area_per_cell$biome_intercept + biome2_area_per_cell$delta_point1)
min(biome2_area_per_cell$cell_intercept)
max(biome2_area_per_cell$cell_intercept)
biome2_area_per_cell$odds_area_0.01 = 10^(biome2_area_per_cell$biome_slope*log10(0.01) + biome2_area_per_cell$cell_intercept)
biome2_area_per_cell$SUM_Lake_area_0.01 = (biome2_area_per_cell$odds_area_0.01/(biome2_area_per_cell$odds_area_0.01 + 1))*biome2_area_per_cell$Sq_area
biome2_area_per_cell$odds_area_0.001 = 10^(biome2_area_per_cell$biome_slope*log10(0.001) + biome2_area_per_cell$cell_intercept)
biome2_area_per_cell$SUM_Lake_area_0.001 = (biome2_area_per_cell$odds_area_0.001/(biome2_area_per_cell$odds_area_0.001 + 1))*biome2_area_per_cell$Sq_area
biome2_area_per_cell$odds_area_0.0001 = 10^(biome2_area_per_cell$biome_slope*log10(0.0001) + biome2_area_per_cell$cell_intercept)
biome2_area_per_cell$SUM_Lake_area_0.0001 = (biome2_area_per_cell$odds_area_0.0001/(biome2_area_per_cell$odds_area_0.0001 + 1))*biome2_area_per_cell$Sq_area
biome2_area_per_cell$pond_area_0.01 = biome2_area_per_cell$SUM_Lake_area_0.01 - biome2_area_per_cell$SUM_Lake_area_0.1
min(biome2_area_per_cell$pond_area_0.01)
max(biome2_area_per_cell$pond_area_0.01)
biome2_area_per_cell$pond_area_0.001 = biome2_area_per_cell$SUM_Lake_area_0.001 - biome2_area_per_cell$SUM_Lake_area_0.01
min(biome2_area_per_cell$pond_area_0.001)
max(biome2_area_per_cell$pond_area_0.001)
biome2_area_per_cell$pond_area_0.0001 = biome2_area_per_cell$SUM_Lake_area_0.0001 - biome2_area_per_cell$SUM_Lake_area_0.001
min(biome2_area_per_cell$pond_area_0.0001)
max(biome2_area_per_cell$pond_area_0.0001)


#biome3
biome3_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "3")
biome3_area_per_cell$biome_slope = -0.09592
biome3_area_per_cell$biome_intercept = -2.43174
biome3_area_per_cell$odds_0.1 = (biome3_area_per_cell$prop_area_0.1) / (1 - biome3_area_per_cell$prop_area_0.1)
biome3_area_per_cell$biome_point1_log = (biome3_area_per_cell$biome_slope*log10(0.1) + biome3_area_per_cell$biome_intercept)
biome3_area_per_cell$cell_point1_log = log10(biome3_area_per_cell$odds_0.1)
biome3_area_per_cell$delta_point1 = abs(biome3_area_per_cell$biome_point1_log - biome3_area_per_cell$cell_point1_log)
biome3_area_per_cell$cell_intercept = ifelse(biome3_area_per_cell$biome_point1_log > biome3_area_per_cell$cell_point1_log,
                                             biome3_area_per_cell$biome_intercept - biome3_area_per_cell$delta_point1,
                                             biome3_area_per_cell$biome_intercept + biome3_area_per_cell$delta_point1)
min(biome3_area_per_cell$cell_intercept)
max(biome3_area_per_cell$cell_intercept)
biome3_area_per_cell$odds_area_0.01 = 10^(biome3_area_per_cell$biome_slope*log10(0.01) + biome3_area_per_cell$cell_intercept)
biome3_area_per_cell$SUM_Lake_area_0.01 = (biome3_area_per_cell$odds_area_0.01/(biome3_area_per_cell$odds_area_0.01 + 1))*biome3_area_per_cell$Sq_area
biome3_area_per_cell$odds_area_0.001 = 10^(biome3_area_per_cell$biome_slope*log10(0.001) + biome3_area_per_cell$cell_intercept)
biome3_area_per_cell$SUM_Lake_area_0.001 = (biome3_area_per_cell$odds_area_0.001/(biome3_area_per_cell$odds_area_0.001 + 1))*biome3_area_per_cell$Sq_area
biome3_area_per_cell$odds_area_0.0001 = 10^(biome3_area_per_cell$biome_slope*log10(0.0001) + biome3_area_per_cell$cell_intercept)
biome3_area_per_cell$SUM_Lake_area_0.0001 = (biome3_area_per_cell$odds_area_0.0001/(biome3_area_per_cell$odds_area_0.0001 + 1))*biome3_area_per_cell$Sq_area
biome3_area_per_cell$pond_area_0.01 = biome3_area_per_cell$SUM_Lake_area_0.01 - biome3_area_per_cell$SUM_Lake_area_0.1
min(biome3_area_per_cell$pond_area_0.01)
max(biome3_area_per_cell$pond_area_0.01)
biome3_area_per_cell$pond_area_0.001 = biome3_area_per_cell$SUM_Lake_area_0.001 - biome3_area_per_cell$SUM_Lake_area_0.01
min(biome3_area_per_cell$pond_area_0.001)
max(biome3_area_per_cell$pond_area_0.001)
biome3_area_per_cell$pond_area_0.0001 = biome3_area_per_cell$SUM_Lake_area_0.0001 - biome3_area_per_cell$SUM_Lake_area_0.001
min(biome3_area_per_cell$pond_area_0.0001)
max(biome3_area_per_cell$pond_area_0.0001)


#biome4
biome4_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "4")
biome4_area_per_cell$biome_slope = -0.055303   
biome4_area_per_cell$biome_intercept = -1.504079   
biome4_area_per_cell$odds_0.1 = (biome4_area_per_cell$prop_area_0.1) / (1 - biome4_area_per_cell$prop_area_0.1)
biome4_area_per_cell$biome_point1_log = (biome4_area_per_cell$biome_slope*log10(0.1) + biome4_area_per_cell$biome_intercept)
biome4_area_per_cell$cell_point1_log = log10(biome4_area_per_cell$odds_0.1)
biome4_area_per_cell$delta_point1 = abs(biome4_area_per_cell$biome_point1_log - biome4_area_per_cell$cell_point1_log)
biome4_area_per_cell$cell_intercept = ifelse(biome4_area_per_cell$biome_point1_log > biome4_area_per_cell$cell_point1_log,
                                             biome4_area_per_cell$biome_intercept - biome4_area_per_cell$delta_point1,
                                             biome4_area_per_cell$biome_intercept + biome4_area_per_cell$delta_point1)
min(biome4_area_per_cell$cell_intercept)
max(biome4_area_per_cell$cell_intercept)
biome4_area_per_cell$odds_area_0.01 = 10^(biome4_area_per_cell$biome_slope*log10(0.01) + biome4_area_per_cell$cell_intercept)
biome4_area_per_cell$SUM_Lake_area_0.01 = (biome4_area_per_cell$odds_area_0.01/(biome4_area_per_cell$odds_area_0.01 + 1))*biome4_area_per_cell$Sq_area
biome4_area_per_cell$odds_area_0.001 = 10^(biome4_area_per_cell$biome_slope*log10(0.001) + biome4_area_per_cell$cell_intercept)
biome4_area_per_cell$SUM_Lake_area_0.001 = (biome4_area_per_cell$odds_area_0.001/(biome4_area_per_cell$odds_area_0.001 + 1))*biome4_area_per_cell$Sq_area
biome4_area_per_cell$odds_area_0.0001 = 10^(biome4_area_per_cell$biome_slope*log10(0.0001) + biome4_area_per_cell$cell_intercept)
biome4_area_per_cell$SUM_Lake_area_0.0001 = (biome4_area_per_cell$odds_area_0.0001/(biome4_area_per_cell$odds_area_0.0001 + 1))*biome4_area_per_cell$Sq_area
biome4_area_per_cell$pond_area_0.01 = biome4_area_per_cell$SUM_Lake_area_0.01 - biome4_area_per_cell$SUM_Lake_area_0.1
min(biome4_area_per_cell$pond_area_0.01)
max(biome4_area_per_cell$pond_area_0.01)
biome4_area_per_cell$pond_area_0.001 = biome4_area_per_cell$SUM_Lake_area_0.001 - biome4_area_per_cell$SUM_Lake_area_0.01
min(biome4_area_per_cell$pond_area_0.001)
max(biome4_area_per_cell$pond_area_0.001)
biome4_area_per_cell$pond_area_0.0001 = biome4_area_per_cell$SUM_Lake_area_0.0001 - biome4_area_per_cell$SUM_Lake_area_0.001
min(biome4_area_per_cell$pond_area_0.0001)
max(biome4_area_per_cell$pond_area_0.0001)


#biome5
biome5_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "5")
biome5_area_per_cell$biome_slope = -0.11857    
biome5_area_per_cell$biome_intercept = -1.88959    
biome5_area_per_cell$odds_0.1 = (biome5_area_per_cell$prop_area_0.1) / (1 - biome5_area_per_cell$prop_area_0.1)
biome5_area_per_cell$biome_point1_log = (biome5_area_per_cell$biome_slope*log10(0.1) + biome5_area_per_cell$biome_intercept)
biome5_area_per_cell$cell_point1_log = log10(biome5_area_per_cell$odds_0.1)
biome5_area_per_cell$delta_point1 = abs(biome5_area_per_cell$biome_point1_log - biome5_area_per_cell$cell_point1_log)
biome5_area_per_cell$cell_intercept = ifelse(biome5_area_per_cell$biome_point1_log > biome5_area_per_cell$cell_point1_log,
                                             biome5_area_per_cell$biome_intercept - biome5_area_per_cell$delta_point1,
                                             biome5_area_per_cell$biome_intercept + biome5_area_per_cell$delta_point1)
min(biome5_area_per_cell$cell_intercept)
max(biome5_area_per_cell$cell_intercept)
biome5_area_per_cell$odds_area_0.01 = 10^(biome5_area_per_cell$biome_slope*log10(0.01) + biome5_area_per_cell$cell_intercept)
biome5_area_per_cell$SUM_Lake_area_0.01 = (biome5_area_per_cell$odds_area_0.01/(biome5_area_per_cell$odds_area_0.01 + 1))*biome5_area_per_cell$Sq_area
biome5_area_per_cell$odds_area_0.001 = 10^(biome5_area_per_cell$biome_slope*log10(0.001) + biome5_area_per_cell$cell_intercept)
biome5_area_per_cell$SUM_Lake_area_0.001 = (biome5_area_per_cell$odds_area_0.001/(biome5_area_per_cell$odds_area_0.001 + 1))*biome5_area_per_cell$Sq_area
biome5_area_per_cell$odds_area_0.0001 = 10^(biome5_area_per_cell$biome_slope*log10(0.0001) + biome5_area_per_cell$cell_intercept)
biome5_area_per_cell$SUM_Lake_area_0.0001 = (biome5_area_per_cell$odds_area_0.0001/(biome5_area_per_cell$odds_area_0.0001 + 1))*biome5_area_per_cell$Sq_area
biome5_area_per_cell$pond_area_0.01 = biome5_area_per_cell$SUM_Lake_area_0.01 - biome5_area_per_cell$SUM_Lake_area_0.1
min(biome5_area_per_cell$pond_area_0.01)
max(biome5_area_per_cell$pond_area_0.01)
biome5_area_per_cell$pond_area_0.001 = biome5_area_per_cell$SUM_Lake_area_0.001 - biome5_area_per_cell$SUM_Lake_area_0.01
min(biome5_area_per_cell$pond_area_0.001)
max(biome5_area_per_cell$pond_area_0.001)
biome5_area_per_cell$pond_area_0.0001 = biome5_area_per_cell$SUM_Lake_area_0.0001 - biome5_area_per_cell$SUM_Lake_area_0.001
min(biome5_area_per_cell$pond_area_0.0001)
max(biome5_area_per_cell$pond_area_0.0001)


#biome6
biome6_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "6")
biome6_area_per_cell$biome_slope = -0.16441    
biome6_area_per_cell$biome_intercept = -1.36619    
biome6_area_per_cell$odds_0.1 = (biome6_area_per_cell$prop_area_0.1) / (1 - biome6_area_per_cell$prop_area_0.1)
biome6_area_per_cell$biome_point1_log = (biome6_area_per_cell$biome_slope*log10(0.1) + biome6_area_per_cell$biome_intercept)
biome6_area_per_cell$cell_point1_log = log10(biome6_area_per_cell$odds_0.1)
biome6_area_per_cell$delta_point1 = abs(biome6_area_per_cell$biome_point1_log - biome6_area_per_cell$cell_point1_log)
biome6_area_per_cell$cell_intercept = ifelse(biome6_area_per_cell$biome_point1_log > biome6_area_per_cell$cell_point1_log,
                                             biome6_area_per_cell$biome_intercept - biome6_area_per_cell$delta_point1,
                                             biome6_area_per_cell$biome_intercept + biome6_area_per_cell$delta_point1)
min(biome6_area_per_cell$cell_intercept)
max(biome6_area_per_cell$cell_intercept)
biome6_area_per_cell$odds_area_0.01 = 10^(biome6_area_per_cell$biome_slope*log10(0.01) + biome6_area_per_cell$cell_intercept)
biome6_area_per_cell$SUM_Lake_area_0.01 = (biome6_area_per_cell$odds_area_0.01/(biome6_area_per_cell$odds_area_0.01 + 1))*biome6_area_per_cell$Sq_area
biome6_area_per_cell$odds_area_0.001 = 10^(biome6_area_per_cell$biome_slope*log10(0.001) + biome6_area_per_cell$cell_intercept)
biome6_area_per_cell$SUM_Lake_area_0.001 = (biome6_area_per_cell$odds_area_0.001/(biome6_area_per_cell$odds_area_0.001 + 1))*biome6_area_per_cell$Sq_area
biome6_area_per_cell$odds_area_0.0001 = 10^(biome6_area_per_cell$biome_slope*log10(0.0001) + biome6_area_per_cell$cell_intercept)
biome6_area_per_cell$SUM_Lake_area_0.0001 = (biome6_area_per_cell$odds_area_0.0001/(biome6_area_per_cell$odds_area_0.0001 + 1))*biome6_area_per_cell$Sq_area
biome6_area_per_cell$pond_area_0.01 = biome6_area_per_cell$SUM_Lake_area_0.01 - biome6_area_per_cell$SUM_Lake_area_0.1
min(biome6_area_per_cell$pond_area_0.01)
max(biome6_area_per_cell$pond_area_0.01)
biome6_area_per_cell$pond_area_0.001 = biome6_area_per_cell$SUM_Lake_area_0.001 - biome6_area_per_cell$SUM_Lake_area_0.01
min(biome6_area_per_cell$pond_area_0.001)
max(biome6_area_per_cell$pond_area_0.001)
biome6_area_per_cell$pond_area_0.0001 = biome6_area_per_cell$SUM_Lake_area_0.0001 - biome6_area_per_cell$SUM_Lake_area_0.001
min(biome6_area_per_cell$pond_area_0.0001)
max(biome6_area_per_cell$pond_area_0.0001)


#biome7
biome7_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "7")
biome7_area_per_cell$biome_slope = -0.03980    
biome7_area_per_cell$biome_intercept = -1.84214    
biome7_area_per_cell$odds_0.1 = (biome7_area_per_cell$prop_area_0.1) / (1 - biome7_area_per_cell$prop_area_0.1)
biome7_area_per_cell$biome_point1_log = (biome7_area_per_cell$biome_slope*log10(0.1) + biome7_area_per_cell$biome_intercept)
biome7_area_per_cell$cell_point1_log = log10(biome7_area_per_cell$odds_0.1)
biome7_area_per_cell$delta_point1 = abs(biome7_area_per_cell$biome_point1_log - biome7_area_per_cell$cell_point1_log)
biome7_area_per_cell$cell_intercept = ifelse(biome7_area_per_cell$biome_point1_log > biome7_area_per_cell$cell_point1_log,
                                             biome7_area_per_cell$biome_intercept - biome7_area_per_cell$delta_point1,
                                             biome7_area_per_cell$biome_intercept + biome7_area_per_cell$delta_point1)
min(biome7_area_per_cell$cell_intercept)
max(biome7_area_per_cell$cell_intercept)
biome7_area_per_cell$odds_area_0.01 = 10^(biome7_area_per_cell$biome_slope*log10(0.01) + biome7_area_per_cell$cell_intercept)
biome7_area_per_cell$SUM_Lake_area_0.01 = (biome7_area_per_cell$odds_area_0.01/(biome7_area_per_cell$odds_area_0.01 + 1))*biome7_area_per_cell$Sq_area
biome7_area_per_cell$odds_area_0.001 = 10^(biome7_area_per_cell$biome_slope*log10(0.001) + biome7_area_per_cell$cell_intercept)
biome7_area_per_cell$SUM_Lake_area_0.001 = (biome7_area_per_cell$odds_area_0.001/(biome7_area_per_cell$odds_area_0.001 + 1))*biome7_area_per_cell$Sq_area
biome7_area_per_cell$odds_area_0.0001 = 10^(biome7_area_per_cell$biome_slope*log10(0.0001) + biome7_area_per_cell$cell_intercept)
biome7_area_per_cell$SUM_Lake_area_0.0001 = (biome7_area_per_cell$odds_area_0.0001/(biome7_area_per_cell$odds_area_0.0001 + 1))*biome7_area_per_cell$Sq_area
biome7_area_per_cell$pond_area_0.01 = biome7_area_per_cell$SUM_Lake_area_0.01 - biome7_area_per_cell$SUM_Lake_area_0.1
min(biome7_area_per_cell$pond_area_0.01)
max(biome7_area_per_cell$pond_area_0.01)
biome7_area_per_cell$pond_area_0.001 = biome7_area_per_cell$SUM_Lake_area_0.001 - biome7_area_per_cell$SUM_Lake_area_0.01
min(biome7_area_per_cell$pond_area_0.001)
max(biome7_area_per_cell$pond_area_0.001)
biome7_area_per_cell$pond_area_0.0001 = biome7_area_per_cell$SUM_Lake_area_0.0001 - biome7_area_per_cell$SUM_Lake_area_0.001
min(biome7_area_per_cell$pond_area_0.0001)
max(biome7_area_per_cell$pond_area_0.0001)


#biome8
biome8_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "8")
biome8_area_per_cell$biome_slope = -0.08965    
biome8_area_per_cell$biome_intercept = -1.73235    
biome8_area_per_cell$odds_0.1 = (biome8_area_per_cell$prop_area_0.1) / (1 - biome8_area_per_cell$prop_area_0.1)
biome8_area_per_cell$biome_point1_log = (biome8_area_per_cell$biome_slope*log10(0.1) + biome8_area_per_cell$biome_intercept)
biome8_area_per_cell$cell_point1_log = log10(biome8_area_per_cell$odds_0.1)
biome8_area_per_cell$delta_point1 = abs(biome8_area_per_cell$biome_point1_log - biome8_area_per_cell$cell_point1_log)
biome8_area_per_cell$cell_intercept = ifelse(biome8_area_per_cell$biome_point1_log > biome8_area_per_cell$cell_point1_log,
                                             biome8_area_per_cell$biome_intercept - biome8_area_per_cell$delta_point1,
                                             biome8_area_per_cell$biome_intercept + biome8_area_per_cell$delta_point1)
min(biome8_area_per_cell$cell_intercept)
max(biome8_area_per_cell$cell_intercept)
biome8_area_per_cell$odds_area_0.01 = 10^(biome8_area_per_cell$biome_slope*log10(0.01) + biome8_area_per_cell$cell_intercept)
biome8_area_per_cell$SUM_Lake_area_0.01 = (biome8_area_per_cell$odds_area_0.01/(biome8_area_per_cell$odds_area_0.01 + 1))*biome8_area_per_cell$Sq_area
biome8_area_per_cell$odds_area_0.001 = 10^(biome8_area_per_cell$biome_slope*log10(0.001) + biome8_area_per_cell$cell_intercept)
biome8_area_per_cell$SUM_Lake_area_0.001 = (biome8_area_per_cell$odds_area_0.001/(biome8_area_per_cell$odds_area_0.001 + 1))*biome8_area_per_cell$Sq_area
biome8_area_per_cell$odds_area_0.0001 = 10^(biome8_area_per_cell$biome_slope*log10(0.0001) + biome8_area_per_cell$cell_intercept)
biome8_area_per_cell$SUM_Lake_area_0.0001 = (biome8_area_per_cell$odds_area_0.0001/(biome8_area_per_cell$odds_area_0.0001 + 1))*biome8_area_per_cell$Sq_area
biome8_area_per_cell$pond_area_0.01 = biome8_area_per_cell$SUM_Lake_area_0.01 - biome8_area_per_cell$SUM_Lake_area_0.1
min(biome8_area_per_cell$pond_area_0.01)
max(biome8_area_per_cell$pond_area_0.01)
biome8_area_per_cell$pond_area_0.001 = biome8_area_per_cell$SUM_Lake_area_0.001 - biome8_area_per_cell$SUM_Lake_area_0.01
min(biome8_area_per_cell$pond_area_0.001)
max(biome8_area_per_cell$pond_area_0.001)
biome8_area_per_cell$pond_area_0.0001 = biome8_area_per_cell$SUM_Lake_area_0.0001 - biome8_area_per_cell$SUM_Lake_area_0.001
min(biome8_area_per_cell$pond_area_0.0001)
max(biome8_area_per_cell$pond_area_0.0001)


#biome9
biome9_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "9")
biome9_area_per_cell$biome_slope = -0.044419   
biome9_area_per_cell$biome_intercept = -1.540531   
biome9_area_per_cell$odds_0.1 = (biome9_area_per_cell$prop_area_0.1) / (1 - biome9_area_per_cell$prop_area_0.1)
biome9_area_per_cell$biome_point1_log = (biome9_area_per_cell$biome_slope*log10(0.1) + biome9_area_per_cell$biome_intercept)
biome9_area_per_cell$cell_point1_log = log10(biome9_area_per_cell$odds_0.1)
biome9_area_per_cell$delta_point1 = abs(biome9_area_per_cell$biome_point1_log - biome9_area_per_cell$cell_point1_log)
biome9_area_per_cell$cell_intercept = ifelse(biome9_area_per_cell$biome_point1_log > biome9_area_per_cell$cell_point1_log,
                                             biome9_area_per_cell$biome_intercept - biome9_area_per_cell$delta_point1,
                                             biome9_area_per_cell$biome_intercept + biome9_area_per_cell$delta_point1)
min(biome9_area_per_cell$cell_intercept)
max(biome9_area_per_cell$cell_intercept)
biome9_area_per_cell$odds_area_0.01 = 10^(biome9_area_per_cell$biome_slope*log10(0.01) + biome9_area_per_cell$cell_intercept)
biome9_area_per_cell$SUM_Lake_area_0.01 = (biome9_area_per_cell$odds_area_0.01/(biome9_area_per_cell$odds_area_0.01 + 1))*biome9_area_per_cell$Sq_area
biome9_area_per_cell$odds_area_0.001 = 10^(biome9_area_per_cell$biome_slope*log10(0.001) + biome9_area_per_cell$cell_intercept)
biome9_area_per_cell$SUM_Lake_area_0.001 = (biome9_area_per_cell$odds_area_0.001/(biome9_area_per_cell$odds_area_0.001 + 1))*biome9_area_per_cell$Sq_area
biome9_area_per_cell$odds_area_0.0001 = 10^(biome9_area_per_cell$biome_slope*log10(0.0001) + biome9_area_per_cell$cell_intercept)
biome9_area_per_cell$SUM_Lake_area_0.0001 = (biome9_area_per_cell$odds_area_0.0001/(biome9_area_per_cell$odds_area_0.0001 + 1))*biome9_area_per_cell$Sq_area
biome9_area_per_cell$pond_area_0.01 = biome9_area_per_cell$SUM_Lake_area_0.01 - biome9_area_per_cell$SUM_Lake_area_0.1
min(biome9_area_per_cell$pond_area_0.01)
max(biome9_area_per_cell$pond_area_0.01)
biome9_area_per_cell$pond_area_0.001 = biome9_area_per_cell$SUM_Lake_area_0.001 - biome9_area_per_cell$SUM_Lake_area_0.01
min(biome9_area_per_cell$pond_area_0.001)
max(biome9_area_per_cell$pond_area_0.001)
biome9_area_per_cell$pond_area_0.0001 = biome9_area_per_cell$SUM_Lake_area_0.0001 - biome9_area_per_cell$SUM_Lake_area_0.001
min(biome9_area_per_cell$pond_area_0.0001)
max(biome9_area_per_cell$pond_area_0.0001)


#biome10
biome10_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "10")
biome10_area_per_cell$biome_slope = -0.09864    
biome10_area_per_cell$biome_intercept = -1.78079    
biome10_area_per_cell$odds_0.1 = (biome10_area_per_cell$prop_area_0.1) / (1 - biome10_area_per_cell$prop_area_0.1)
biome10_area_per_cell$biome_point1_log = (biome10_area_per_cell$biome_slope*log10(0.1) + biome10_area_per_cell$biome_intercept)
biome10_area_per_cell$cell_point1_log = log10(biome10_area_per_cell$odds_0.1)
biome10_area_per_cell$delta_point1 = abs(biome10_area_per_cell$biome_point1_log - biome10_area_per_cell$cell_point1_log)
biome10_area_per_cell$cell_intercept = ifelse(biome10_area_per_cell$biome_point1_log > biome10_area_per_cell$cell_point1_log,
                                             biome10_area_per_cell$biome_intercept - biome10_area_per_cell$delta_point1,
                                             biome10_area_per_cell$biome_intercept + biome10_area_per_cell$delta_point1)
min(biome10_area_per_cell$cell_intercept)
max(biome10_area_per_cell$cell_intercept)
biome10_area_per_cell$odds_area_0.01 = 10^(biome10_area_per_cell$biome_slope*log10(0.01) + biome10_area_per_cell$cell_intercept)
biome10_area_per_cell$SUM_Lake_area_0.01 = (biome10_area_per_cell$odds_area_0.01/(biome10_area_per_cell$odds_area_0.01 + 1))*biome10_area_per_cell$Sq_area
biome10_area_per_cell$odds_area_0.001 = 10^(biome10_area_per_cell$biome_slope*log10(0.001) + biome10_area_per_cell$cell_intercept)
biome10_area_per_cell$SUM_Lake_area_0.001 = (biome10_area_per_cell$odds_area_0.001/(biome10_area_per_cell$odds_area_0.001 + 1))*biome10_area_per_cell$Sq_area
biome10_area_per_cell$odds_area_0.0001 = 10^(biome10_area_per_cell$biome_slope*log10(0.0001) + biome10_area_per_cell$cell_intercept)
biome10_area_per_cell$SUM_Lake_area_0.0001 = (biome10_area_per_cell$odds_area_0.0001/(biome10_area_per_cell$odds_area_0.0001 + 1))*biome10_area_per_cell$Sq_area
biome10_area_per_cell$pond_area_0.01 = biome10_area_per_cell$SUM_Lake_area_0.01 - biome10_area_per_cell$SUM_Lake_area_0.1
min(biome10_area_per_cell$pond_area_0.01)
max(biome10_area_per_cell$pond_area_0.01)
biome10_area_per_cell$pond_area_0.001 = biome10_area_per_cell$SUM_Lake_area_0.001 - biome10_area_per_cell$SUM_Lake_area_0.01
min(biome10_area_per_cell$pond_area_0.001)
max(biome10_area_per_cell$pond_area_0.001)
biome10_area_per_cell$pond_area_0.0001 = biome10_area_per_cell$SUM_Lake_area_0.0001 - biome10_area_per_cell$SUM_Lake_area_0.001
min(biome10_area_per_cell$pond_area_0.0001)
max(biome10_area_per_cell$pond_area_0.0001)


#biome11
biome11_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "11")
biome11_area_per_cell$biome_slope = -0.36105    
biome11_area_per_cell$biome_intercept = -1.74681    
biome11_area_per_cell$odds_0.1 = (biome11_area_per_cell$prop_area_0.1) / (1 - biome11_area_per_cell$prop_area_0.1)
biome11_area_per_cell$biome_point1_log = (biome11_area_per_cell$biome_slope*log10(0.1) + biome11_area_per_cell$biome_intercept)
biome11_area_per_cell$cell_point1_log = log10(biome11_area_per_cell$odds_0.1)
biome11_area_per_cell$delta_point1 = abs(biome11_area_per_cell$biome_point1_log - biome11_area_per_cell$cell_point1_log)
biome11_area_per_cell$cell_intercept = ifelse(biome11_area_per_cell$biome_point1_log > biome11_area_per_cell$cell_point1_log,
                                             biome11_area_per_cell$biome_intercept - biome11_area_per_cell$delta_point1,
                                             biome11_area_per_cell$biome_intercept + biome11_area_per_cell$delta_point1)
min(biome11_area_per_cell$cell_intercept)
max(biome11_area_per_cell$cell_intercept)
biome11_area_per_cell$odds_area_0.01 = 10^(biome11_area_per_cell$biome_slope*log10(0.01) + biome11_area_per_cell$cell_intercept)
biome11_area_per_cell$SUM_Lake_area_0.01 = (biome11_area_per_cell$odds_area_0.01/(biome11_area_per_cell$odds_area_0.01 + 1))*biome11_area_per_cell$Sq_area
biome11_area_per_cell$odds_area_0.001 = 10^(biome11_area_per_cell$biome_slope*log10(0.001) + biome11_area_per_cell$cell_intercept)
biome11_area_per_cell$SUM_Lake_area_0.001 = (biome11_area_per_cell$odds_area_0.001/(biome11_area_per_cell$odds_area_0.001 + 1))*biome11_area_per_cell$Sq_area
biome11_area_per_cell$odds_area_0.0001 = 10^(biome11_area_per_cell$biome_slope*log10(0.0001) + biome11_area_per_cell$cell_intercept)
biome11_area_per_cell$SUM_Lake_area_0.0001 = (biome11_area_per_cell$odds_area_0.0001/(biome11_area_per_cell$odds_area_0.0001 + 1))*biome11_area_per_cell$Sq_area
biome11_area_per_cell$pond_area_0.01 = biome11_area_per_cell$SUM_Lake_area_0.01 - biome11_area_per_cell$SUM_Lake_area_0.1
min(biome11_area_per_cell$pond_area_0.01)
max(biome11_area_per_cell$pond_area_0.01)
biome11_area_per_cell$pond_area_0.001 = biome11_area_per_cell$SUM_Lake_area_0.001 - biome11_area_per_cell$SUM_Lake_area_0.01
min(biome11_area_per_cell$pond_area_0.001)
max(biome11_area_per_cell$pond_area_0.001)
biome11_area_per_cell$pond_area_0.0001 = biome11_area_per_cell$SUM_Lake_area_0.0001 - biome11_area_per_cell$SUM_Lake_area_0.001
min(biome11_area_per_cell$pond_area_0.0001)
max(biome11_area_per_cell$pond_area_0.0001)

#biome12
biome12_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "12")
biome12_area_per_cell$biome_slope = -0.14968    
biome12_area_per_cell$biome_intercept = -2.36745    
biome12_area_per_cell$odds_0.1 = (biome12_area_per_cell$prop_area_0.1) / (1 - biome12_area_per_cell$prop_area_0.1)
biome12_area_per_cell$biome_point1_log = (biome12_area_per_cell$biome_slope*log10(0.1) + biome12_area_per_cell$biome_intercept)
biome12_area_per_cell$cell_point1_log = log10(biome12_area_per_cell$odds_0.1)
biome12_area_per_cell$delta_point1 = abs(biome12_area_per_cell$biome_point1_log - biome12_area_per_cell$cell_point1_log)
biome12_area_per_cell$cell_intercept = ifelse(biome12_area_per_cell$biome_point1_log > biome12_area_per_cell$cell_point1_log,
                                             biome12_area_per_cell$biome_intercept - biome12_area_per_cell$delta_point1,
                                             biome12_area_per_cell$biome_intercept + biome12_area_per_cell$delta_point1)
min(biome12_area_per_cell$cell_intercept)
max(biome12_area_per_cell$cell_intercept)
biome12_area_per_cell$odds_area_0.01 = 10^(biome12_area_per_cell$biome_slope*log10(0.01) + biome12_area_per_cell$cell_intercept)
biome12_area_per_cell$SUM_Lake_area_0.01 = (biome12_area_per_cell$odds_area_0.01/(biome12_area_per_cell$odds_area_0.01 + 1))*biome12_area_per_cell$Sq_area
biome12_area_per_cell$odds_area_0.001 = 10^(biome12_area_per_cell$biome_slope*log10(0.001) + biome12_area_per_cell$cell_intercept)
biome12_area_per_cell$SUM_Lake_area_0.001 = (biome12_area_per_cell$odds_area_0.001/(biome12_area_per_cell$odds_area_0.001 + 1))*biome12_area_per_cell$Sq_area
biome12_area_per_cell$odds_area_0.0001 = 10^(biome12_area_per_cell$biome_slope*log10(0.0001) + biome12_area_per_cell$cell_intercept)
biome12_area_per_cell$SUM_Lake_area_0.0001 = (biome12_area_per_cell$odds_area_0.0001/(biome12_area_per_cell$odds_area_0.0001 + 1))*biome12_area_per_cell$Sq_area
biome12_area_per_cell$pond_area_0.01 = biome12_area_per_cell$SUM_Lake_area_0.01 - biome12_area_per_cell$SUM_Lake_area_0.1
min(biome12_area_per_cell$pond_area_0.01)
max(biome12_area_per_cell$pond_area_0.01)
biome12_area_per_cell$pond_area_0.001 = biome12_area_per_cell$SUM_Lake_area_0.001 - biome12_area_per_cell$SUM_Lake_area_0.01
min(biome12_area_per_cell$pond_area_0.001)
max(biome12_area_per_cell$pond_area_0.001)
biome12_area_per_cell$pond_area_0.0001 = biome12_area_per_cell$SUM_Lake_area_0.0001 - biome12_area_per_cell$SUM_Lake_area_0.001
min(biome12_area_per_cell$pond_area_0.0001)
max(biome12_area_per_cell$pond_area_0.0001)


#biome13
biome13_area_per_cell = subset(lake_area_per_cell, BIOME_NUM == "13")
biome13_area_per_cell$biome_slope = -0.021658   
biome13_area_per_cell$biome_intercept = -1.456237   
biome13_area_per_cell$odds_0.1 = (biome13_area_per_cell$prop_area_0.1) / (1 - biome13_area_per_cell$prop_area_0.1)
biome13_area_per_cell$biome_point1_log = (biome13_area_per_cell$biome_slope*log10(0.1) + biome13_area_per_cell$biome_intercept)
biome13_area_per_cell$cell_point1_log = log10(biome13_area_per_cell$odds_0.1)
biome13_area_per_cell$delta_point1 = abs(biome13_area_per_cell$biome_point1_log - biome13_area_per_cell$cell_point1_log)
biome13_area_per_cell$cell_intercept = ifelse(biome13_area_per_cell$biome_point1_log > biome13_area_per_cell$cell_point1_log,
                                             biome13_area_per_cell$biome_intercept - biome13_area_per_cell$delta_point1,
                                             biome13_area_per_cell$biome_intercept + biome13_area_per_cell$delta_point1)
min(biome13_area_per_cell$cell_intercept)
max(biome13_area_per_cell$cell_intercept)
biome13_area_per_cell$odds_area_0.01 = 10^(biome13_area_per_cell$biome_slope*log10(0.01) + biome13_area_per_cell$cell_intercept)
biome13_area_per_cell$SUM_Lake_area_0.01 = (biome13_area_per_cell$odds_area_0.01/(biome13_area_per_cell$odds_area_0.01 + 1))*biome13_area_per_cell$Sq_area
biome13_area_per_cell$odds_area_0.001 = 10^(biome13_area_per_cell$biome_slope*log10(0.001) + biome13_area_per_cell$cell_intercept)
biome13_area_per_cell$SUM_Lake_area_0.001 = (biome13_area_per_cell$odds_area_0.001/(biome13_area_per_cell$odds_area_0.001 + 1))*biome13_area_per_cell$Sq_area
biome13_area_per_cell$odds_area_0.0001 = 10^(biome13_area_per_cell$biome_slope*log10(0.0001) + biome13_area_per_cell$cell_intercept)
biome13_area_per_cell$SUM_Lake_area_0.0001 = (biome13_area_per_cell$odds_area_0.0001/(biome13_area_per_cell$odds_area_0.0001 + 1))*biome13_area_per_cell$Sq_area
biome13_area_per_cell$pond_area_0.01 = biome13_area_per_cell$SUM_Lake_area_0.01 - biome13_area_per_cell$SUM_Lake_area_0.1
min(biome13_area_per_cell$pond_area_0.01)
max(biome13_area_per_cell$pond_area_0.01)
biome13_area_per_cell$pond_area_0.001 = biome13_area_per_cell$SUM_Lake_area_0.001 - biome13_area_per_cell$SUM_Lake_area_0.01
min(biome13_area_per_cell$pond_area_0.001)
max(biome13_area_per_cell$pond_area_0.001)
biome13_area_per_cell$pond_area_0.0001 = biome13_area_per_cell$SUM_Lake_area_0.0001 - biome13_area_per_cell$SUM_Lake_area_0.001
min(biome13_area_per_cell$pond_area_0.0001)
max(biome13_area_per_cell$pond_area_0.0001)

#and then combine these new estimates into a simplified data table for pond scaling
big_pond_area = rbind(biome1_area_per_cell, biome2_area_per_cell, biome3_area_per_cell, biome4_area_per_cell, biome5_area_per_cell,
                      biome6_area_per_cell, biome7_area_per_cell, biome8_area_per_cell, biome9_area_per_cell, biome10_area_per_cell,
                      biome11_area_per_cell, biome12_area_per_cell, biome13_area_per_cell)
big_pond_area = big_pond_area %>%
  dplyr::select("FID", "Sq_area", "Lat", "Long","Cell_ID", "pond_area_0.01", "pond_area_0.001", "pond_area_0.0001")

#export it
write.csv(big_pond_area, "pond_area_estimates.csv")

```



Now use the updated dataset that includes the grid cells and estimated pond and small lake < 0.1 km2 area per grid cell for the predictions
```{r}
ponds_area_by_biome <- big_pond_area
ponds_area_by_biome$dummy_0.01 = 0.01
ponds_area_by_biome$dummy_0.001 = 0.001
ponds_area_by_biome$dummy_0.0001 = 0.0001

ponds_area_by_biome = rename(ponds_area_by_biome, 
                             lat = Lat, 
                             long = Long, 
                             est_area_0.01 = pond_area_0.01, 
                             est_area_0.001 = pond_area_0.001, 
                             est_area_0.0001 = pond_area_0.0001)

#for the rf predictions, we need the lat, long, and "dummy" columns
#we will run a prediction for each size class to get a size class mean rate, then recombine this with the area data to estimate a per cell "pond mean", "pond error", and "pond total" estimate.
pond_area_df = ponds_area_by_biome[,c("lat", "long", "est_area_0.01", "est_area_0.001", "est_area_0.0001", "dummy_0.01", "dummy_0.001", "dummy_0.0001")]

#now attach the extra data
#use the same mean elevation approach as for wetlands
require(sf)
pfertilizer = raster("pfertilizer_global.tif")
points = data.frame(lon = (pond_area_df$long), lat = (pond_area_df$lat))
points_sf = st_as_sf(points, coords = c("lon", "lat"), crs = "WGS84")
points_p = extract(pfertilizer, points_sf)
pond_area_df2 = cbind(pond_area_df, points_p)
pond_area_df2 = rename(pond_area_df2, p_fert_kg_ha = points_p)

nfertilizer = raster("nfertilizer_global.tif")
points_n = extract(nfertilizer, points_sf)
pond_area_df3 = cbind(pond_area_df2, points_n)
pond_area_df3 = rename(pond_area_df3, n_fert_kg_ha = points_n)

mean_annual_temp = raster("wc2.1_2.5m_bio_1.tif")
points_temp = extract(mean_annual_temp, points_sf)
pond_area_df4 = cbind(pond_area_df3, points_temp)
pond_area_df4 = rename(pond_area_df4, mean_annual_temp_c = points_temp)

annual_precip = raster("wc2.1_2.5m_bio_12.tif")
points_precip = extract(annual_precip, points_sf)
pond_area_df5 = cbind(pond_area_df4, points_precip)
pond_area_df5 = rename(pond_area_df5, annual_precip_mm = points_precip)

elevation = raster("GDEM-10km-colorized.tif")
points_elev = extract(elevation, points_sf)
pond_area_df6 = cbind(pond_area_df5, points_elev)


pond_area_df6$elevation_km = pond_area_df6$points_elev/100
#get it named right
pond_area_df6$abs_lat = abs(pond_area_df6$lat)
pond_area_df6$log_n_fert = log10(pond_area_df6$n_fert_kg_ha + 0.00000000001)
pond_area_df6$log_p_fert = log10(pond_area_df6$p_fert_kg_ha + 0.00000000001)
pond_area_df6$log_precip = log10(pond_area_df6$annual_precip_mm/10)
pond_area_df6$elevation_km = pond_area_df6$points_elev/100

pond_area_df6[is.na(pond_area_df6)] <- 0

#start with 0.01 size class
#remove other size classes

pond_predict_01_df = pond_area_df6 %>% dplyr::select(dummy_0.01, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
pond_predict_01_df$log_area = log10(pond_predict_01_df$dummy_0.01)
pond_predict_01_df2 = pond_predict_01_df %>% dplyr::select(log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
#run the prediciton
global_pond_0.01_bury = predict(pond_rf, pond_predict_01_df2, type = "se", se.method = "infjack")

#re-attach it to the lat_long data
est_0_01_c_bury = cbind(ponds_area_by_biome, global_pond_0.01_bury)

sum(is.na(est_0_01_c_bury$global_pond_0.01_bury))

#and get cell specific mean burial rate
est_0_01_c_bury$c_burial_g_m2_yr = 10^est_0_01_c_bury$prediction
sum(is.na(est_0_01_c_bury$c_burial_g_m2_yr))

#then estimate sum of burial for this size class
est_0_01_c_bury$sum = est_0_01_c_bury$c_burial_g_m2_yr*1000000*(est_0_01_c_bury$est_area_0.01)
sum(is.na(est_0_01_c_bury$sum))

#switch all the NA to zero:
est_0_01_c_bury$sum[is.na(est_0_01_c_bury$sum)] = 0
sum(est_0_01_c_bury$sum)

###get the mean and SD of rates
mean(est_0_01_c_bury$c_burial_g_m2_yr)
sd(est_0_01_c_bury$c_burial_g_m2_yr)

#now for the total scaling, need to check for NA
sum(is.na(est_0_01_c_bury$est_area_0.01))
#six na for area - switch to zero
est_0_01_c_bury$est_area_0.01[is.na(est_0_01_c_bury$est_area_0.01)] = 0

sum(is.na(est_0_01_c_bury$c_burial_g_m2_yr))
#no NA

pond_01_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(est_0_01_c_bury$prediction), mean = est_0_01_c_bury$prediction, sd = est_0_01_c_bury$se))* est_0_01_c_bury$est_area_0.01*1000000),
               length(est_0_01_c_bury$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

pond_01_total_mean1 = as.vector(pond_01_total_mean)
mean(pond_01_total_mean1)/(10^12)
sd(pond_01_total_mean1)/(10^12)
median(pond_01_total_mean1)/(10^12)
quantile(pond_01_total_mean1, probs = 0.25)/(10^12)
quantile(pond_01_total_mean1, probs = 0.75)/(10^12)


#repeat for 0.001
pond_predict_001_df = pond_area_df6 %>% dplyr::select(dummy_0.001, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
pond_predict_001_df$log_area = log10(pond_predict_001_df$dummy_0.001)
pond_predict_001_df2 = pond_predict_001_df %>% dplyr::select(log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
global_pond_0.001_bury = predict(pond_rf, pond_predict_001_df2, type = "se", se.method = "infjack")
est_0_001_c_bury = cbind(ponds_area_by_biome, global_pond_0.001_bury)
est_0_001_c_bury$c_burial_g_m2_yr = 10^est_0_001_c_bury$prediction
est_0_001_c_bury$sum = est_0_001_c_bury$c_burial_g_m2_yr*1000000*(est_0_001_c_bury$est_area_0.001)
sum(na.omit(est_0_001_c_bury$sum))/(10^12)

##get the mean and SD of rates
mean(est_0_001_c_bury$c_burial_g_m2_yr)
sd(est_0_001_c_bury$c_burial_g_m2_yr)

#now for the total scaling, need to check for NA
sum(is.na(est_0_001_c_bury$est_area_0.001))
#six na for area - switch to zero
est_0_001_c_bury$est_area_0.001[is.na(est_0_001_c_bury$est_area_0.001)] = 0

sum(is.na(est_0_001_c_bury$c_burial_g_m2_yr))
#no NA

pond_001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(est_0_001_c_bury$prediction), mean = est_0_001_c_bury$prediction, sd = est_0_001_c_bury$se))* est_0_001_c_bury$est_area_0.001*1000000),
               length(est_0_001_c_bury$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

pond_001_total_mean1 = as.vector(pond_001_total_mean)
mean(pond_001_total_mean1)/(10^12)
sd(pond_001_total_mean1)/(10^12)
median(pond_001_total_mean1)/(10^12)
quantile(pond_001_total_mean1, probs = 0.25)/(10^12)
quantile(pond_001_total_mean1, probs = 0.75)/(10^12)

####and for 0.0001 size ponds
pond_predict_0001_df = pond_area_df6 %>% dplyr::select(dummy_0.0001, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
pond_predict_0001_df$log_area = log10(pond_predict_0001_df$dummy_0.0001)
pond_predict_0001_df2 = pond_predict_0001_df %>% dplyr::select(log_area, abs_lat,
                                             log_n_fert, log_p_fert, log_precip, elevation_km, mean_annual_temp_c)
global_pond_0.0001_bury = predict(pond_rf, pond_predict_0001_df2, type = "se", se.method = "infjack")
est_0_0001_c_bury = cbind(ponds_area_by_biome, global_pond_0.0001_bury)
est_0_0001_c_bury$c_burial_g_m2_yr = 10^est_0_0001_c_bury$prediction
est_0_0001_c_bury$sum = est_0_0001_c_bury$c_burial_g_m2_yr*1000000*(est_0_0001_c_bury$est_area_0.0001)
sum(na.omit(est_0_0001_c_bury$sum))

#now for the total scaling, need to check for NA
sum(is.na(est_0_0001_c_bury$est_area_0.0001))
#six na for area - switch to zero
est_0_0001_c_bury$est_area_0.0001[is.na(est_0_0001_c_bury$est_area_0.0001)] = 0

sum(is.na(est_0_0001_c_bury$c_burial_g_m2_yr))
#no NA

mean(est_0_0001_c_bury$c_burial_g_m2_yr)
sd(est_0_0001_c_bury$c_burial_g_m2_yr)

pond_0001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(est_0_0001_c_bury$prediction), mean = est_0_0001_c_bury$prediction, sd = est_0_0001_c_bury$se))* (est_0_0001_c_bury$est_area_0.0001)*1000000),
               length(est_0_0001_c_bury$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

pond_0001_total_mean1 = as.vector(pond_0001_total_mean)
mean(pond_0001_total_mean1)/(10^12)
sd(pond_0001_total_mean1)/(10^12)
median(pond_0001_total_mean1)/(10^12)
quantile(pond_0001_total_mean1, probs = 0.25)/(10^12)
quantile(pond_0001_total_mean1, probs = 0.75)/(10^12)

#grand sum for ponds:
pond_grand_total_mean = (mean(pond_01_total_mean1)/(10^12)) + (mean(pond_001_total_mean1)/(10^12)) + (mean(pond_0001_total_mean1)/(10^12))
pond_grand_total_mean
pond_grand_total_sd = sqrt((sd(pond_01_total_mean)^2) + (sd(pond_001_total_mean)^2) + (sd(pond_0001_total_mean)^2))/(10^12)
pond_grand_total_sd

```



Now, make the pond maps
```{r}
#rename things from pond prediction dataframes
global_pond_burial = as.data.frame(cbind(est_0_01_c_bury$lat, est_0_01_c_bury$long, est_0_01_c_bury$c_burial_g_m2_yr, est_0_001_c_bury$c_burial_g_m2_yr, est_0_001_c_bury$c_burial_g_m2_yr, est_0_01_c_bury$est_area_0.01, est_0_001_c_bury$est_area_0.001, est_0_0001_c_bury$est_area_0.0001, est_0_01_c_bury$sum, est_0_001_c_bury$sum, est_0_0001_c_bury$sum, est_0_01_c_bury$se, est_0_001_c_bury$se, est_0_0001_c_bury$se))

global_pond_burial = global_pond_burial %>%
  rename("lat" = "V1",
         "long" = "V2",
         "mean_bury_01" = "V3",
         "mean_bury_001" = "V4",
         "mean_bury_0001" = "V5",
         "area_01" = "V6",
         "area_001" = "V7",
         "area_0001" = "V8",
         "sum_01" = "V9",
         "sum_001" = "V10",
         "sum_0001" = "V11",
         "se_01" = "V12",
         "se_001" = "V13",
         "se_0001" = "V14")

max(global_pond_burial$lat)
min(global_pond_burial$lat)
max(global_pond_burial$long)
min(global_pond_burial$long)

#now, get the area corrected mean
global_pond_burial$grid_cell_av_rate = ((global_pond_burial$mean_bury_01 * (global_pond_burial$area_01)) +
  (global_pond_burial$mean_bury_001 * (global_pond_burial$area_001))+
  (global_pond_burial$mean_bury_0001 * (global_pond_burial$area_0001)))/(global_pond_burial$area_01 + global_pond_burial$area_001 + global_pond_burial$area_0001)
max(na.omit(global_pond_burial$grid_cell_av_rate))
min(na.omit(global_pond_burial$grid_cell_av_rate))
mean(na.omit(global_pond_burial$grid_cell_av_rate))
sd(na.omit(global_pond_burial$grid_cell_av_rate))

#and the total burial per cell
global_pond_burial$cell_total = global_pond_burial$sum_01 + global_pond_burial$sum_001 + global_pond_burial$sum_0001

write.csv(global_pond_burial, "global_pond_burial.csv")
```



```{r}
#and get the average and sd for rates and total burial by latitude - will need to use each size class estimate and then sum them and re-calc sd:

#start with the smallest ponds
est_0_0001_lat_dat = est_0_0001_c_bury
est_0_0001_lat_dat$lat_categories = cut(abs(pond_lat_dat$lat), breaks = c(0,23.4361,66.5,90),
                                  labels = c("tropical", "temperate", "polar"))


pond_0_0001_lat_avs = est_0_0001_lat_dat %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
pond_0_0001_lat_avs


tropical_0_0001 = subset(est_0_0001_lat_dat, lat_categories == "tropical")

tropical_0_0001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_0_0001$prediction), mean = tropical_0_0001$prediction, sd = tropical_0_0001$se))*tropical_0_0001$est_area_0.0001*1000000), 
               length(tropical_0_0001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_0_0001_total_mean1 = as.vector(tropical_0_0001_total_mean)
mean(tropical_0_0001_total_mean1)/(10^12)
sd(tropical_0_0001_total_mean1)/(10^12)
median(tropical_0_0001_total_mean1)/(10^12)
quantile(tropical_0_0001_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_0_0001_total_mean1, probs = 0.75)/(10^12)


temperate_0_0001 = subset(est_0_0001_lat_dat, lat_categories == "temperate")

temperate_0_0001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_0_0001$prediction), mean = temperate_0_0001$prediction, sd = temperate_0_0001$se))*temperate_0_0001$est_area_0.0001*1000000), 
               length(temperate_0_0001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_0_0001_total_mean1 = as.vector(temperate_0_0001_total_mean)
mean(temperate_0_0001_total_mean1)/(10^12)
sd(temperate_0_0001_total_mean1)/(10^12)
median(temperate_0_0001_total_mean1)/(10^12)
quantile(temperate_0_0001_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_0_0001_total_mean1, probs = 0.75)/(10^12)


polar_0_0001 = subset(est_0_0001_lat_dat, lat_categories == "polar")

polar_0_0001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_0_0001$prediction), mean = polar_0_0001$prediction, sd = polar_0_0001$se))*polar_0_0001$est_area_0.0001*1000000), 
               length(polar_0_0001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_0_0001_total_mean1 = as.vector(polar_0_0001_total_mean)
mean(polar_0_0001_total_mean1)/(10^12)
sd(polar_0_0001_total_mean1)/(10^12)
median(polar_0_0001_total_mean1)/(10^12)
quantile(polar_0_0001_total_mean1, probs = 0.25)/(10^12)
quantile(polar_0_0001_total_mean1, probs = 0.75)/(10^12)


###repeat for the middle size
est_0_001_lat_dat = est_0_001_c_bury
est_0_001_lat_dat$lat_categories = cut(abs(pond_lat_dat$lat), breaks = c(0,23.4361,66.5,90),
                                  labels = c("tropical", "temperate", "polar"))


pond_0_001_lat_avs = est_0_001_lat_dat %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
pond_0_001_lat_avs


tropical_0_001 = subset(est_0_001_lat_dat, lat_categories == "tropical")

tropical_0_001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_0_001$prediction), mean = tropical_0_001$prediction, sd = tropical_0_001$se))*tropical_0_001$est_area_0.001*1000000), 
               length(tropical_0_001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_0_001_total_mean1 = as.vector(tropical_0_001_total_mean)
mean(tropical_0_001_total_mean1)/(10^12)
sd(tropical_0_001_total_mean1)/(10^12)
median(tropical_0_001_total_mean1)/(10^12)
quantile(tropical_0_001_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_0_001_total_mean1, probs = 0.75)/(10^12)


temperate_0_001 = subset(est_0_001_lat_dat, lat_categories == "temperate")

temperate_0_001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_0_001$prediction), mean = temperate_0_001$prediction, sd = temperate_0_001$se))*temperate_0_001$est_area_0.001*1000000), 
               length(temperate_0_001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_0_001_total_mean1 = as.vector(temperate_0_001_total_mean)
mean(temperate_0_001_total_mean1)/(10^12)
sd(temperate_0_001_total_mean1)/(10^12)
median(temperate_0_001_total_mean1)/(10^12)
quantile(temperate_0_001_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_0_001_total_mean1, probs = 0.75)/(10^12)


polar_0_001 = subset(est_0_001_lat_dat, lat_categories == "polar")

polar_0_001_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_0_001$prediction), mean = polar_0_001$prediction, sd = polar_0_001$se))*polar_0_001$est_area_0.001*1000000), 
               length(polar_0_001$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_0_001_total_mean1 = as.vector(polar_0_001_total_mean)
mean(polar_0_001_total_mean1)/(10^12)
sd(polar_0_001_total_mean1)/(10^12)
median(polar_0_001_total_mean1)/(10^12)
quantile(polar_0_001_total_mean1, probs = 0.25)/(10^12)
quantile(polar_0_001_total_mean1, probs = 0.75)/(10^12)

#and the largest ponds
est_0_01_lat_dat = est_0_01_c_bury
est_0_01_lat_dat$lat_categories = cut(abs(pond_lat_dat$lat), breaks = c(0,23.4361,66.5,90),
                                  labels = c("tropical", "temperate", "polar"))


pond_0_01_lat_avs = est_0_01_lat_dat %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(c_burial_g_m2_yr),
                      list(mean = mean,
                           sd = sd,
                           min = min,
                           max = max))
pond_0_01_lat_avs


tropical_0_01 = subset(est_0_01_lat_dat, lat_categories == "tropical")

tropical_0_01_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(tropical_0_01$prediction), mean = tropical_0_01$prediction, sd = tropical_0_01$se))*tropical_0_01$est_area_0.01*1000000), 
               length(tropical_0_01$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

tropical_0_01_total_mean1 = as.vector(tropical_0_01_total_mean)
mean(tropical_0_01_total_mean1)/(10^12)
sd(tropical_0_01_total_mean1)/(10^12)
median(tropical_0_01_total_mean1)/(10^12)
quantile(tropical_0_01_total_mean1, probs = 0.25)/(10^12)
quantile(tropical_0_01_total_mean1, probs = 0.75)/(10^12)


temperate_0_01 = subset(est_0_01_lat_dat, lat_categories == "temperate")

temperate_0_01_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(temperate_0_01$prediction), mean = temperate_0_01$prediction, sd = temperate_0_01$se))*temperate_0_01$est_area_0.01*1000000), 
               length(temperate_0_01$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

temperate_0_01_total_mean1 = as.vector(temperate_0_01_total_mean)
mean(temperate_0_01_total_mean1)/(10^12)
sd(temperate_0_01_total_mean1)/(10^12)
median(temperate_0_01_total_mean1)/(10^12)
quantile(temperate_0_01_total_mean1, probs = 0.25)/(10^12)
quantile(temperate_0_01_total_mean1, probs = 0.75)/(10^12)


polar_0_01 = subset(est_0_01_lat_dat, lat_categories == "polar")

polar_0_01_total_mean = replicate(n = 1000, expr = {
  x_i = sample(((10^rnorm(n = length(polar_0_01$prediction), mean = polar_0_01$prediction, sd = polar_0_01$se))*polar_0_01$est_area_0.01*1000000), 
               length(polar_0_01$c_burial_g_m2_yr), replace = T)
  sum(x_i)
})

polar_0_01_total_mean1 = as.vector(polar_0_01_total_mean)
mean(polar_0_01_total_mean1)/(10^12)
sd(polar_0_01_total_mean1)/(10^12)
median(polar_0_01_total_mean1)/(10^12)
quantile(polar_0_01_total_mean1, probs = 0.25)/(10^12)
quantile(polar_0_01_total_mean1, probs = 0.75)/(10^12)

#and look at averages by lat bin
global_pond_burial$lat_categories = cut(abs(global_pond_burial$lat), breaks = c(0,23.4361,66.5,90),
                                  labels = c("tropical", "temperate", "polar"))

sum(is.na(global_pond_burial$grid_cell_av_rate))
pond_est = global_pond_burial
pond_est = pond_est[!is.na(pond_est$grid_cell_av_rate),]

global_pond_lat_avs = pond_est %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(grid_cell_av_rate),
                      list(mean = na.omit(mean),
                           sd = sd,
                           min = min,
                           max = max))
global_pond_lat_avs

###and then get the total and sd for each band
tropical_total_mean = (mean(tropical_0_0001_total_mean1)/(10^12)) + (mean(tropical_0_001_total_mean1)/(10^12)) + (mean(tropical_0_01_total_mean1)/(10^12))
tropical_total_mean
tropical_total_sd = sqrt((sd(tropical_0_0001_total_mean1)^2) + (sd(tropical_0_001_total_mean1)^2) + (sd(tropical_0_01_total_mean1)^2))/(10^12)
tropical_total_sd

temperate_total_mean = (mean(temperate_0_0001_total_mean1)/(10^12)) + (mean(temperate_0_001_total_mean1)/(10^12)) + (mean(temperate_0_01_total_mean1)/(10^12))
temperate_total_mean
temperate_total_sd = sqrt((sd(temperate_0_0001_total_mean1)^2) + (sd(temperate_0_001_total_mean1)^2) + (sd(temperate_0_01_total_mean1)^2))/(10^12)
temperate_total_sd

polar_total_mean = (mean(polar_0_0001_total_mean1)/(10^12)) + (mean(polar_0_001_total_mean1)/(10^12)) + (mean(polar_0_01_total_mean1)/(10^12))
polar_total_mean
polar_total_sd = sqrt((sd(polar_0_0001_total_mean1)^2) + (sd(polar_0_001_total_mean1)^2) + (sd(polar_0_01_total_mean1)^2))/(10^12)
polar_total_sd

#and get global pond areas by latitude
global_pond_burial$sum_area = global_pond_burial$area_01 + global_pond_burial$area_001 + global_pond_burial$area_0001

pond_area_summary = global_pond_burial %>%
  group_by(lat_categories) %>%
  dplyr::summarize_at(vars(sum_area),list(sum = sum))
pond_area_summary
```


Make a latitudinal histogram to show where burial takes place
Include dashed lines showing temperate, tropical, polar
```{r}
#use the datafiles previously generated
#global_lake_burial
#global_reservoir_burial
#global_wetland_burial
#global_pond_burial

#get the lake data pooled by latitude
lake_lat_sum_dat = subset(global_lake_burial, select = c("lat", "burial", "c_burial_g_m2_yr"))
lake_lat_sum_dat$lat_bin = floor(lake_lat_sum_dat$lat) 
lake_lat_sum_bin = lake_lat_sum_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_bury = sum(burial),
            av_bury = mean(c_burial_g_m2_yr))
lake_lat_sum_bin$type = "Lake"
#repeat for the reservoir data
res_lat_sum_dat = subset(global_reservoir_burial, select = c("lat", "burial", "c_burial_g_m2_yr"))
res_lat_sum_dat$lat_bin = floor(res_lat_sum_dat$lat) 
res_lat_sum_bin = res_lat_sum_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_bury = sum(burial),
            av_bury = mean(c_burial_g_m2_yr))
res_lat_sum_bin$type = "Impoundment"
#and the wetland data
wetland_lat_sum_dat = subset(global_wetland_burial, select = c("lat", "burial","c_burial_g_m2_yr"))
wetland_lat_sum_dat$lat_bin = floor(wetland_lat_sum_dat$lat) 
wetland_lat_sum_bin = wetland_lat_sum_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_bury = sum(burial),
            av_bury = mean(c_burial_g_m2_yr))
wetland_lat_sum_bin$type = "Wetland"
#and the pond data
pond_lat_sum_dat = subset(global_pond_burial, select = c("lat", "cell_total", "grid_cell_av_rate"))
pond_lat_sum_dat$lat_bin = floor(pond_lat_sum_dat$lat) 
pond_lat_sum_bin = pond_lat_sum_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_bury = sum(cell_total),
            av_bury = mean(grid_cell_av_rate))
pond_lat_sum_bin$type = "Pond"

#combine
lentic_lat_burial = rbind(lake_lat_sum_bin, res_lat_sum_bin, pond_lat_sum_bin, wetland_lat_sum_bin)

#make a three panel plot:
#panel a is total system area by latitude (stacked)
#panel b is average burial rate by latitude (line)
#panel c is total burial by latitude (stacked)

#the system area plot
lake_area_lat_bin_dat = subset(hydro_lake, select = c("Pour_lat", "Lake_area"))
lake_area_lat_bin_dat$lat_bin = floor(lake_area_lat_bin_dat$Pour_lat)
lake_area_sum_bin = lake_area_lat_bin_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_area = sum(Lake_area))
lake_area_sum_bin$type = "Lake"

imp_area_lat_bin_dat = subset(hydro_reservoir, select = c("Pour_lat", "Lake_area"))
imp_area_lat_bin_dat$lat_bin = floor(imp_area_lat_bin_dat$Pour_lat)
imp_area_sum_bin = imp_area_lat_bin_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_area = sum(Lake_area))
imp_area_sum_bin$type = "Impoundment"

wetland_area_lat_bin_dat = GLWD_V2_wetlands_km2_1d_res
wetland_area_lat_bin_dat$lat_bin = floor(wetland_area_lat_bin_dat$lat)
wetland_area_sum_bin = wetland_area_lat_bin_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_area = sum(wetland_km))
wetland_area_sum_bin$type = "Wetland"

pond_area_lat_bin_dat = subset(global_pond_burial, select = c("lat", "area_01", "area_001", "area_0001"))
pond_area_lat_bin_dat$area = (pond_area_lat_bin_dat$area_01 + pond_area_lat_bin_dat$area_001 + pond_area_lat_bin_dat$area_0001)
pond_area_lat_bin_dat$lat_bin = floor(pond_area_lat_bin_dat$lat)
pond_area_sum_bin = pond_area_lat_bin_dat %>%
  group_by(lat_bin) %>%
  summarise(sum_area = sum(area))
pond_area_sum_bin$type = "Pond"

lentic_area = rbind(lake_area_sum_bin, imp_area_sum_bin, wetland_area_sum_bin, pond_area_sum_bin)

options(scipen = 999)
stacked_area_plot = ggplot()+
  geom_area(data = lentic_area, aes(x = lat_bin, y = (sum_area/(10^5)), fill = type))+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c"))+
  theme_classic()+
  labs(y = "Area<br>(100,000 km<sup>2</sup>)",
       x = "Latitude")+
  scale_x_continuous(limits = c(-90, 90), breaks = c(-90,-75,-60, -45, -30, -15, 0, 15, 30, 45, 60, 75, 90))+
  theme(panel.border = element_rect(colour = "black", fill = NA))+
  theme(legend.position = "none")+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_text(size = 7,colour = "black"),
        axis.title.x =  element_markdown(size = 7,colour = "black"),
         axis.title.y =  element_markdown(size = 7,colour = "black"))+
  geom_vline(xintercept = 66.5, linetype = "dashed")+
  geom_vline(xintercept = 23.436, linetype = "dashed")+
  geom_vline(xintercept = -23.436, linetype = "dashed")+
  geom_vline(xintercept = -66.5, linetype = "dashed")+
  coord_flip()

stacked_area_plot
options(scipen = 0)

#make the average rate plot
av_plot_dat = lentic_lat_burial %>% filter(!is.na(av_bury))
lat_rate_plot = ggplot()+
  geom_line(data = av_plot_dat, aes(x = lat_bin, y = av_bury, color = type))+
  scale_color_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c"))+
  theme_classic()+
  labs(y = "Average Burial Rate<br>(g OC m<sup>-2</sup> y<sup>-1</sup>)",
       x = "Latitude")+
  scale_x_continuous(limits = c(-90, 90), breaks = c(-90,-75,-60, -45, -30, -15, 0, 15, 30, 45, 60, 75, 90))+
  theme(panel.border = element_rect(colour = "black", fill = NA))+
  theme(legend.position = "none")+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_text(size = 7,colour = "black"),
        axis.title.x =  element_markdown(size = 7,colour = "black"),
         axis.title.y =  element_markdown(size = 7,colour = "black"))+
  geom_vline(xintercept = 66.5, linetype = "dashed")+
  geom_vline(xintercept = 23.436, linetype = "dashed")+
  geom_vline(xintercept = -23.436, linetype = "dashed")+
  geom_vline(xintercept = -66.5, linetype = "dashed")+
  coord_flip()+
  annotate('text', label = "Polar", y = 250, x = 90, size = 2.469, hjust = 1)+
  annotate('text', label = "Temperate", y = 250, x = 60, size = 2.469, hjust = 1)+
  annotate('text', label = "Tropical", y = 250, x = 17, size = 2.469, hjust = 1)+
  annotate('text', label = "Temperate", y = 250, x = -30, size = 2.469, hjust = 1)+
  annotate('text', label = "Polar", y = 250, x = -73, size = 2.469, hjust = 1)+
  annotate("rect", xmin = -74, xmax = -70, ymin = 0, ymax = 10.4, fill = "#a6cee3")+
  annotate('text', label = "Impoundment", y = 12.5, x = -74, size = 2.469, hjust = 0, vjust = 0)+
  annotate("rect", xmin = -79, xmax = -75, ymin = 0, ymax = 10.4, fill = "#1f78b4")+
  annotate('text', label = "Lake", y = 12.5, x = -79, size = 2.469, hjust = 0, vjust = 0)+
  annotate("rect", xmin = -84, xmax = -80, ymin = 0, ymax = 10.4, fill = "#b2df8a")+
  annotate('text', label = "Pond", y = 12.5, x = -84, size = 2.469, hjust = 0, vjust = 0)+
  annotate("rect", xmin = -89, xmax = -85, ymin = 0, ymax = 10.4, fill = "#33a02c")+
  annotate('text', label = "Wetland", y = 12.5, x = -89, size = 2.469, hjust = 0, vjust = 0)
lat_rate_plot

#make the stacked area graph
stacked_bury_plot = ggplot()+
  geom_area(data = lentic_lat_burial, aes(x = lat_bin, y = (sum_bury/(10^12)), fill = type))+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c"))+
  theme_classic()+
  labs(y = "Carbon Burial<br>(Tg OC y<sup>-1</sup>)",
       x = "Latitude")+
  scale_x_continuous(limits = c(-90, 90), breaks = c(-90,-75,-60, -45, -30, -15, 0, 15, 30, 45, 60, 75, 90))+
  theme(panel.border = element_rect(colour = "black", fill = NA))+
  theme(legend.position = "none")+
  theme(axis.text.x =  element_text(size = 7,colour = "black"),
         axis.text.y =  element_text(size = 7,colour = "black"),
        axis.title.x =  element_markdown(size = 7,colour = "black"),
         axis.title.y =  element_markdown(size = 7,colour = "black"))+
  geom_vline(xintercept = 66.5, linetype = "dashed")+
  geom_vline(xintercept = 23.436, linetype = "dashed")+
  geom_vline(xintercept = -23.436, linetype = "dashed")+
  geom_vline(xintercept = -66.5, linetype = "dashed")+
  coord_flip()
stacked_bury_plot

lat_bury_panel = lat_rate_plot + stacked_area_plot + stacked_bury_plot +
  plot_layout(nrow = 1, ncol = 3)+
  plot_annotation(tag_levels = "a")&
  theme(plot.tag = element_text(size = 7, face = "bold"))

lat_bury_panel[[2]] = lat_bury_panel[[2]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())
lat_bury_panel[[3]] = lat_bury_panel[[3]] + theme(axis.text.y = element_blank(), axis.title.y = element_blank())

lat_bury_panel

ggsave(filename = "lat_bury_panel.png", plot = lat_bury_panel, width = 183, height = 100, units = "mm")


```






